
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="An out-of-the-box open source library for scientific computing based on deep learning.">
      
      
        <meta name="author" content="PaddlePaddle">
      
      
        <link rel="canonical" href="https://github.com/PaddlePaddle/PaddleScience/zh/examples/moflow/">
      
      
        <link rel="prev" href="../tgcn/">
      
      
        <link rel="next" href="../../api/arch/">
      
      
      <link rel="icon" href="../../../images/icons/favcion.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Moflow - PaddleScience Docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      

  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M256 512a256 256 0 1 0 0-512 256 256 0 1 0 0 512m-86.2-346.7c7.9-22.3 29.1-37.3 52.8-37.3h58.3c34.9 0 63.1 28.3 63.1 63.1 0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6-13.3 0-24-10.7-24-24v-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1 0-8.4-6.8-15.1-15.1-15.1h-58.3c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1-64 0"/></svg>');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Serif SC";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#moflowflow-model-for-molecular" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="PaddleScience Docs" class="md-header__button md-logo" aria-label="PaddleScience Docs" data-md-component="logo">
      
  <img src="../../../images/icons/paddle.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PaddleScience Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Moflow
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/zh/" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/PaddlePaddle/PaddleScience" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    PaddleScience
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  PaddleScience

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../allen_cahn/" class="md-tabs__link">
          
  
  经典案例

        </a>
      </li>
    
  

    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/arch/" class="md-tabs__link">
          
  
  API 文档

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../user_guide/" class="md-tabs__link">
        
  
    
  
  使用指南

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../development/" class="md-tabs__link">
          
  
  开发与复现指南

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../academic/" class="md-tabs__link">
        
  
    
  
  学术成果

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../technical_doc/" class="md-tabs__link">
        
  
    
  
  技术稿件

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../cooperation/" class="md-tabs__link">
        
  
    
  
  共创计划

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://aistudio.baidu.com/aistudio/projectoverview/public?topic=15" class="md-tabs__link">
        
  
    
  
  实训社区

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="PaddleScience Docs" class="md-nav__button md-logo" aria-label="PaddleScience Docs" data-md-component="logo">
      
  <img src="../../../images/icons/paddle.png" alt="logo">

    </a>
    PaddleScience Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PaddlePaddle/PaddleScience" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    PaddleScience
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    PaddleScience
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            PaddleScience
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    功能介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../install_setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    安装使用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速开始
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    学习资料
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    经典案例
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            经典案例
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
     
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
             
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    数学(AI for Math)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            数学(AI for Math)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../allen_cahn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AllenCahn
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deephpms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeepHPMs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deeponet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeepONet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../euler_beam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Euler_Beam
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../laplace2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Laplace2D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lorenz/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lorenz_transform_physx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pirbn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PIRBN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rossler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rossler_transform_physx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../volterra_ide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Volterra_IDE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nlsmb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NLSMB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spinn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SPINN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../xpinns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    XPINN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../neuraloperator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NeuralOperator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../brusselator3d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Brusselator3D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../transformer4sr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Transformer4SR
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    技术科学(AI for Technology)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            技术科学(AI for Technology)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2_1" id="__nav_2_1_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    流体
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2_1">
            <span class="md-nav__icon md-icon"></span>
            流体
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../amgnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMGNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../aneurysm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aneurysm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bubble/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BubbleNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cfdgcn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CFDGCN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adv_cvit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CVit(Advection)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ns_cvit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CVit(NS)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cylinder2d_unsteady/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cylinder2D_unsteady
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cylinder2d_unsteady_transformer_physx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cylinder2D_unsteady_transform_physx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../darcy2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Darcy2D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deepcfd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeepCFD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ldc2d_steady/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDC2D_steady
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ldc2d_unsteady/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDC2D_unsteady
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../labelfree_DNN_surrogate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Labelfree_DNN_surrogate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nsfnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NSFNets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../phycrnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PhyCRNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../shock_wave/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ShockWave
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tempoGAN/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tempoGAN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nsfnet4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NSFNet4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../viv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ViV
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2_2" id="__nav_2_1_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    结构
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2_2">
            <span class="md-nav__icon md-icon"></span>
            结构
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../biharmonic2d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Biharmonic2D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bracket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bracket
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../control_arm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Control_arm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../epnn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EPNN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../phylstm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Phy-LSTM
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../topopt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TopOpt
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../heart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Heart
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2_3" id="__nav_2_1_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    传热
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_1_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2_3">
            <span class="md-nav__icon md-icon"></span>
            传热
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../heat_exchanger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Heat_Exchanger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../heat_pinn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Heat_PINN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../phygeonet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PhyGeoNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chip_heat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Chip_heat
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_3" id="__nav_2_1_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    材料科学(AI for Material)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            材料科学(AI for Material)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hpinns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    hPINNs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cgcnn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CGCNN
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_4" >
        
          
          <label class="md-nav__link" for="__nav_2_1_4" id="__nav_2_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    地球科学(AI for Earth Science)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_4">
            <span class="md-nav__icon md-icon"></span>
            地球科学(AI for Earth Science)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extformer_moe/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extformer-MoE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fourcastnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FourCastNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nowcastnet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NowcastNet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dgmr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DGMR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../earthformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    EarthFormer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../graphcast/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GraphCast
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../velocity_gan/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VelocityGAN
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tgcn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TGCN
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_5" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1_5" id="__nav_2_1_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    化学科学(AI for Chemistry)
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1_5">
            <span class="md-nav__icon md-icon"></span>
            化学科学(AI for Chemistry)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Moflow
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Moflow
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 背景简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 模型原理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 模型原理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 模型的基础框架
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-moflow" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 MoFlow模型的原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 模型的实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 模型的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 数据处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 约束构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 模型构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 学习率与优化器构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 评估器构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 模型训练与评估
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37" class="md-nav__link">
    <span class="md-ellipsis">
      3.7 模型的生成评估构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#38" class="md-nav__link">
    <span class="md-ellipsis">
      3.8 模型的优化构建
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 训练完整代码
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5.参考文献
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API 文档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API 文档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            ppsci
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/arch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.arch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/autodiff/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.autodiff
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/constraint/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.constraint
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_4" >
        
          
          <label class="md-nav__link" for="__nav_3_1_4" id="__nav_3_1_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci.data
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_4">
            <span class="md-nav__icon md-icon"></span>
            ppsci.data
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data/dataset/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.data.dataset
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data/process/transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.data.transform
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/data/process/batch_transform/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.data.batch_transform
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/equation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.equation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/geometry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.geometry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_7" >
        
          
          <label class="md-nav__link" for="__nav_3_1_7" id="__nav_3_1_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci.loss
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_7">
            <span class="md-nav__icon md-icon"></span>
            ppsci.loss
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/loss/loss/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.loss.loss
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/loss/mtl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.loss.mtl
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/metric/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.metric
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_9" >
        
          
          <label class="md-nav__link" for="__nav_3_1_9" id="__nav_3_1_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci.optimizer
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_9">
            <span class="md-nav__icon md-icon"></span>
            ppsci.optimizer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/optimizer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.optimizer.optimizer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/lr_scheduler/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.optimizer.lr_scheduler
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/solver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.solver
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1_11" >
        
          
          <label class="md-nav__link" for="__nav_3_1_11" id="__nav_3_1_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    ppsci.utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_1_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1_11">
            <span class="md-nav__icon md-icon"></span>
            ppsci.utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/checker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.checker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/expression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.expression
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/initializer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.initializer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.logger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/misc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.misc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/ema/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.ema
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/reader/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.reader
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/writer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.writer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/save_load/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.save_load
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/utils/symbolic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.utils.symbolic
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/validate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.validate
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/visualize/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.visualize
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/experimental/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.experimental
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/probability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ppsci.probability
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    deploy
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            deploy
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/depoly/python_infer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    deploy.python_infer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    使用指南
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    开发与复现指南
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            开发与复现指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开发指南
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reproduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    复现指南
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../academic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    学术成果
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../technical_doc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    技术稿件
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cooperation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    共创计划
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://aistudio.baidu.com/aistudio/projectoverview/public?topic=15" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    实训社区
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 背景简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 模型原理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 模型原理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 模型的基础框架
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-moflow" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 MoFlow模型的原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3. 模型的实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 模型的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 数据处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 约束构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 模型构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 学习率与优化器构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 评估器构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 模型训练与评估
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37" class="md-nav__link">
    <span class="md-ellipsis">
      3.7 模型的生成评估构建
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#38" class="md-nav__link">
    <span class="md-ellipsis">
      3.8 模型的优化构建
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 训练完整代码
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5.参考文献
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/PaddlePaddle/PaddleScience/edit/develop/docs/zh/examples/moflow.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/PaddlePaddle/PaddleScience/raw/develop/docs/zh/examples/moflow.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5"/></svg>
    </a>
  


<div><h1 id="moflowflow-model-for-molecular">MoFlow(Flow Model for Molecular)<a class="headerlink" href="#moflowflow-model-for-molecular" title="Permanent link">¶</a></h1>
<!--
<a href="https://aistudio.baidu.com/aistudio/projectdetail/6184070?contributionType=1&sUid=438690&shared=1&ts=1684239806160" class="md-button md-button--primary" style>AI Studio快速体验</a>
-->

<div class="admonition note">
<p class="admonition-title">注意事项</p>
<ol>
<li>开始训练、评估前，请先下载 <a href="https://aistudio.baidu.com/datasetdetail/282687">QM9数据集和ZINC数据集</a>，并对应修改 yaml 配置文件中的 <code>FILE_PATH</code> 为解压后的数据集路径，建议放置在例子./datasets/moflow中。</li>
<li>开始始训练、测试、优化评估前，请安装额外的化学包和数据显示转化工具 <code>pip install -r requirements.txt</code> 命令，安装 <a href="https://github.com/rdkit/rdkit">rdkit</a> 化学工具和 <a href="https://github.com/Kozea/CairoSVG">cairosvg</a> 数据转换保存工具。</li>
<li>预训模型需要进行修改，并且放到指定文件夹，修改对应的 yaml 配置文件，执行命令式分子生成不合理的话出现的提示可以不管</li>
</ol>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked id="__tabbed_1_1" name="__tabbed_1" type="radio"><input id="__tabbed_1_2" name="__tabbed_1" type="radio"><input id="__tabbed_1_3" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">模型训练命令</label><label for="__tabbed_1_2">模型推理评估命令</label><label for="__tabbed_1_3">模型优化评估命令</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># qm9 数据集模型训练</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>python<span class="w"> </span>moflow_train.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>qm9
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># zinc250k 数据集模型训练</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>python<span class="w"> </span>moflow_train.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>zinc250k
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># qm9 数据集预训练模型生成评估， 其中EVAL_mode=Reconstruct为重构生成， EVAL_mode=Random为随机生成，EVAL_mode=Inter2point为分子间插值生成，EVAL_mode=Intergrid为分子网格插值生成，详细说明参考3.7模型的生成评估构建</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>python<span class="w"> </span>test_generate.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>qm9<span class="w"> </span><span class="nv">EVAL_mode</span><span class="o">=</span>Reconstruct<span class="w"> </span>EVAL.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/qm9/qm9_pretrained.pdparams
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="c1"># zinc250k 数据集预训练模型生成评估，其中EVAL_mode=Reconstruct为重构生成， EVAL_mode=Random为随机生成，EVAL_mode=Inter2point为分子间插值生成，EVAL_mode=Intergrid为分子网格插值生成，详细说明参考3.7模型的生成评估构建</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>python<span class="w"> </span>test_generate.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>zinc250k<span class="w"> </span><span class="nv">EVAL_mode</span><span class="o">=</span>Reconstruct<span class="w"> </span>EVAL.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/zinc250k/zinc250k_pretrained.pdparams
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-sh highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># 方式一：不采用预训练模型，第一次运行为模型训练，第二次运行为预测生成结果输出</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1"># qm9 数据集预训练模型优化，其中OPTIMIZE.property_name=qed为潜空间到QED属性，OPTIMIZE.property_name=plogp从潜空间到plogp属性，详细说明参考3.8模型的优化构建</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>python<span class="w"> </span>optimize_moflow.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>qm9<span class="w">  </span>TRAIN.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/qm9/qm9_pretrained.pdparams<span class="w">  </span>OPTIMIZE.property_name<span class="o">=</span>qed
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1"># zinc250k 数据集预训练模型优化，其中OPTIMIZE.property_name=qed为潜空间到QED属性，OPTIMIZE.property_name=plogp从潜空间到plogp属性，详细说明参考3.8模型的优化构建</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>python<span class="w"> </span>optimize_moflow.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>zinc250k<span class="w">  </span>TRAIN.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/zinc250k/zinc250k_pretrained.pdparams<span class="w"> </span>OPTIMIZE.property_name<span class="o">=</span>qed
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1"># 方式二：采用提供预训模型，下载优化后的模型进行预测结果生成输出</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="c1"># qm9 数据集预训练模型优化</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>./outputs_moflow_optimize/qm9/
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/qm9/qed_opt_pretrained.pdparams<span class="w"> </span>-O<span class="w"> </span>./outputs_moflow_optimize/qm9/qed_model.pdparams
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>python<span class="w"> </span>optimize_moflow.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>qm9<span class="w">  </span>TRAIN.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/qm9/qm9_pretrained.pdparams<span class="w">  </span>OPTIMIZE.property_name<span class="o">=</span>qed
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/qm9/plogp_opt_pretrained.pdparams<span class="w"> </span>-O<span class="w"> </span>./outputs_moflow_optimize/qm9/plogp_model.pdparams
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>python<span class="w"> </span>optimize_moflow.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>qm9<span class="w">  </span>TRAIN.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/qm9/qm9_pretrained.pdparams<span class="w">  </span>OPTIMIZE.property_name<span class="o">=</span>plogp
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="c1"># zinc250k 数据集预训练模型优化</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>mkdir<span class="w"> </span>-p<span class="w"> </span>./outputs_moflow_optimize/zinc250k/
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/zinc250k/qed_opt_pretrained.pdparams<span class="w"> </span>-O<span class="w"> </span>./outputs_moflow_optimize/zinc250k/qed_model.pdparams
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>python<span class="w"> </span>optimize_moflow.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>zinc250k<span class="w">  </span>TRAIN.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/zinc250k/zinc250k_pretrained.pdparams<span class="w"> </span>OPTIMIZE.property_name<span class="o">=</span>qed
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>wget<span class="w"> </span>-nc<span class="w"> </span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/zinc250k/plogp_opt_pretrained.pdparams<span class="w"> </span>-O<span class="w"> </span>./outputs_moflow_optimize/zinc250k/plogp_model.pdparams
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>python<span class="w"> </span>optimize_moflow.py<span class="w"> </span><span class="nv">data_name</span><span class="o">=</span>zinc250k<span class="w">  </span>TRAIN.pretrained_model_path<span class="o">=</span>https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/zinc250k/zinc250k_pretrained.pdparams<span class="w"> </span>OPTIMIZE.property_name<span class="o">=</span>plogp
</span></code></pre></div>
</div>
</div>
</div>
<table>
<thead>
<tr>
<th style="text-align: left;">预训练模型</th>
<th style="text-align: left;">指标</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><a href="https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/qm9/qm9_pretrained.pdparams">qm9</a></td>
<td style="text-align: left;">loss(Residual): <br> 1.09976</td>
</tr>
<tr>
<td style="text-align: left;"><a href="https://paddle-org.bj.bcebos.com/paddlescience/models/MoFlow/zinc250k/zinc250k_pretrained.pdparams">zinc250k</a></td>
<td style="text-align: left;">loss(Residual):: <br> 1.12570</td>
</tr>
</tbody>
</table>
<h2 id="1">1. 背景简介<a class="headerlink" href="#1" title="Permanent link">¶</a></h2>
<p>MoFlow一种基于流的图生成模型，旨在通过生成具有所需化学特性的分子图来加速药物发现过程。这样的图生成模型通常包括两个步骤：学习潜在表示和生成分子图，从潜在表示中生成新颖且符合化学规则的分子图是非常具有挑战性的，因为分子图具有化学约束和组合复杂性</p>
<p>MoFlow，用于学习分子图与其潜在表示之间的可逆映射，首先通过基于Glow的模型生成键（边），然后通过一种新颖的图条件流模型给定键来生成原子（节点），最后通过后处理的有效性修正将它们组装成一个符合化学规则的分子图，具有准确且可计算的似然训练、高效的一次嵌入和生成、化学有效性保证、对训练数据的100%重构以及良好的泛化能力等优点。其中的Glow模型的一个变种来生成键（多类型边，例如单键、双键和三键），以及一种基于图卷积的新颖图条件流来根据键生成原子（多类型节点，例如C、N等，将原子和键组装成符合键值约束的有效分子图）。</p>
<p>MoFlow是首个能够通过可逆映射一次生成分子图并具有有效性保证的基于流的图生成模型之一，为了捕捉分子图的组合原子和键结构，提出的Glow模型用于生成键（边），以及一种基于图条件流的新颖方法用于根据键生成原子（节点），然后将它们组装成有效的分子图；在分子图生成、重构、优化等方面实现了许多较好的结果，一次推理和生成非常高效，这意味着它在探索化学空间用于药物发现方面具高效性和有效性的潜力。</p>
<h2 id="2">2. 模型原理<a class="headerlink" href="#2" title="Permanent link">¶</a></h2>
<p>本章节仅对MoFlow的模型原理进行简单地介绍，详细的模型结构及推到过程阅读论文<a href="https://arxiv.org/abs/2006.10137v1">MoFlow: An Invertible Flow Model for Generating Molecular Graphs</a></p>
<h3 id="21">2.1 模型的基础框架<a class="headerlink" href="#21" title="Permanent link">¶</a></h3>
<p>Flow流模型在学习复杂高维数据<span class="arithmatex">\(X \sim P_\mathcal{X}(X)\)</span>与具有相同维数的潜在空间中的<span class="arithmatex">\(Z \sim P_\mathcal{Z}(Z)\)</span>之间的一系列可逆变换<span class="arithmatex">\(f_Θ = f_L ◦ ... ◦ f_1\)</span>，其中潜在分布<span class="arithmatex">\(P_\mathcal{Z}(Z)\)</span>易于建模（例如，在这样的潜在空间中成立强独立性假设）。原始空间中的潜在复杂数据可以通过变量变换公式来建模，其中<span class="arithmatex">\(Z = f_Θ(X)\)</span>以及：</p>
<div class="arithmatex">\[
\begin{aligned}
P_\mathcal{X}(X) &amp; = P_\mathcal{Z}(Z)|\det(\frac{\partial Z}{\partial X})
\end{aligned}
\]</div>
<p>采样<span class="arithmatex">\(\widetilde{X} \sim P_\mathcal{X}(X)\)</span>通过采样<span class="arithmatex">\(\widetilde{Z} \sim P_\mathcal{Z}(Z)\)</span>，然后通过<span class="arithmatex">\(\widetilde{X} = f_Θ^{−1}\widetilde{Z}\)</span>进行反向映射来转换<span class="arithmatex">\(f_Θ\)</span>。设<span class="arithmatex">\(Z = f_Θ(X) = f_L ◦ ... ◦ f_1(X)，H_l = f_l(H_{l−1})\)</span>，其中<span class="arithmatex">\(f_l(l = 1, ...L ∈ \mathbb{N}^+)\)</span>是可逆映射，<span class="arithmatex">\(H_0 = X，H_L = Z\)</span>，并且<span class="arithmatex">\(P_\mathcal{Z}(Z)\)</span>遵循具有独立维度的标准各向同性高斯分布。然后，可以通过变量变换公式得到<span class="arithmatex">\(X\)</span>的似然对数：</p>
<div class="arithmatex">\[
\begin{aligned}
\log P_\mathcal{X}(X) &amp;=\log P_\mathcal{Z}(Z) + \log \left|\det\left(\frac{\partial Z}{\partial X}\right) \right| \\
&amp;= \sum_{i} \log P_{\mathcal{Z}_i}(Z_i) + \sum_{l=1}^L \log \left|\det\left(\frac{\partial f_l}{\partial H_{l−1}}\right)\right|
\end{aligned}
\]</div>
<p>其中<span class="arithmatex">\(P_{\mathcal{Z}_i}(Z_i)\)</span>是<span class="arithmatex">\(Z\)</span>的第<span class="arithmatex">\(i^{th}\)</span>个维度的概率，<span class="arithmatex">\(fΘ = f_L ◦ ... ◦ f_1\)</span> 是要学习的可逆深度神经网络。</p>
<p>Coupling可逆放射耦合层，设计一个具有可逆性的函数f的表达性结构，能够计算雅可比行列式的效率通过一个仿射耦合变换<span class="arithmatex">\(Z = f_Θ(X): \mathbb{R}^n \mapsto \mathbb{R}^n\)</span>:</p>
<div class="arithmatex">\[
\begin{aligned}
Z_{1:d} &amp; = X_{1:d} \\
Z_{d+1:n} &amp; = X_{d+1:n} ⊙ e^{S_Θ(X_{1:d})} + T_Θ(X_{1:d})
\end{aligned}
\]</div>
<p>通过将<span class="arithmatex">\(X\)</span>分为两个分区<span class="arithmatex">\(X = (X_{1:d}, X_{d+1:n})\)</span>,通过以下方式保证可逆性：</p>
<div class="arithmatex">\[
\begin{aligned}
X_{1:d} &amp; = Z_{1:d} \\
X_{d+1:n} &amp; = (Z_{d+1:n} - T_Θ(X_{1:d}) )/ e^{S_Θ(Z_{1:d})}
\end{aligned}
\]</div>
<p>表达能力取决于<span class="arithmatex">\(X_{d+1:n}\)</span>的仿射变换中的任意神经结构的尺度函数 <span class="arithmatex">\(S_Θ：\mathbb{R}^d \mapsto \mathbb{R}^{n-d}\)</span>和变换函数 <span class="arithmatex">\(T_Θ：\mathbb{R}^d \mapsto \mathbb{R}^{n-d}\)</span>，雅可比行列式可以通过以下方式高效计算：<span class="arithmatex">\(\det(\frac{\partial Z}{\partial X}) = \exp(\sum_j S_Θ(X_{1:d}))\)</span>。</p>
<h3 id="22-moflow">2.2 MoFlow模型的原理<a class="headerlink" href="#22-moflow" title="Permanent link">¶</a></h3>
<p>将<span class="arithmatex">\(\text{M}\)</span>分子图视为由原子作节点，键作边组成的无向图，其数学符号可记为<span class="arithmatex">\(\mathcal{M} =  \mathcal{A} \times  \mathcal{B} \subset \mathbb{R}^{n \times k} \times \mathbb{R}^{c \times n \times n}\)</span>，其中，集合有<span class="arithmatex">\(n\)</span>个原子，<span class="arithmatex">\(k\)</span>种原子类型，<span class="arithmatex">\(A(i,k)=1\)</span>代表节点<span class="arithmatex">\(i\)</span>是<span class="arithmatex">\(k\)</span>型原子，集合代表键（边）,键有<span class="arithmatex">\(c\)</span>种类型，<span class="arithmatex">\(B(c,i,j)=1\)</span>代表原子<span class="arithmatex">\(i\)</span>和<span class="arithmatex">\(j\)</span>之间以<span class="arithmatex">\(c\)</span>类型的键连接,一个分子<span class="arithmatex">\(\mathcal{M}\)</span>可以被看作是一个具有多类型节点和多类型边的无向图。主要的目标是学习一个分子生成模型<span class="arithmatex">\(P_{\mathcal{M}}(M)\)</span>，即从<span class="arithmatex">\(P_{\mathcal{M}}\)</span>中采样任意分子<span class="arithmatex">\(\text{M}\)</span>的概率。为了捕捉分子图的组合原子和键结构，将<span class="arithmatex">\(P_{\mathcal{M}}(M)\)</span>分解为两部分：</p>
<div class="arithmatex">\[
\begin{aligned}
P_\mathcal{M}(M) = P_{\mathcal{M}}((A, B)) ≈ P_{\mathcal{A|B}}(A|B; θ_{\mathcal{A|B}})P_\mathcal{B}(B; θ_\mathcal{B})
\end{aligned}
\]</div>
<p>其中<span class="arithmatex">\(P_{\mathcal{M}}\)</span>是分子图的分布，<span class="arithmatex">\(P_\mathcal{B}\)</span>是键（边）的分布，类似于对多通道图像建模，而<span class="arithmatex">\(P_{\mathcal{A|B}}\)</span>是给定键的条件下的原子（节点）的条件分布，通过利用图卷积操作进行建模。<span class="arithmatex">\(θ_\mathcal{B}\)</span>和<span class="arithmatex">\(θ_{\mathcal{A|B}}\)</span>是可学习的建模参数。该模型的目标函数如下：</p>
<div class="arithmatex">\[
\begin{aligned}
\mathop{\arg\max}\limits_{\theta_\mathcal{B}, \theta_\mathcal{A|B}}
\mathbb{E}_{\mathcal{M}=(A,B) \sim \mathcal{PM}−data} [ \log P_\mathcal{A|B}(A | B; θ_\mathcal{A|B} + \log P_\mathcal{B}(B; θ_\mathcal{B})]
\end{aligned}
\]</div>
<p>在给定键张量<span class="arithmatex">\(B \in \mathcal{B} \subset \mathbb{R}^{c×n×n}\)</span>，生成正确的原子类型矩阵<span class="arithmatex">\(A \in \mathcal{A} \subset \mathbb{R}^{n×k}\)</span>，以组成有效的分子<span class="arithmatex">\(M = (A, B) \in \mathcal{M} \subset \mathbb{R}^{n×k+c×n×n}\)</span>。首先定义<span class="arithmatex">\(B\)</span>条件流和图条件流<span class="arithmatex">\(f_\mathcal{A|B}\)</span>，将给定<span class="arithmatex">\(B\)</span>的<span class="arithmatex">\(A\)</span>转化为条件潜变量<span class="arithmatex">\(Z_{A|B} = f_\mathcal{A|B}(A|B)\)</span>，其遵循各向同性高斯分布<span class="arithmatex">\(P_{\mathcal{Z}_\mathcal{A|B}}\)</span>。通过条件变量变换公式，可以得到给定键图的原子特征的条件概率<span class="arithmatex">\(P_\mathcal{A|B}\)</span>。<span class="arithmatex">\(B\)</span>条件流<span class="arithmatex">\(Z_{A|B} = f_\mathcal{A|B}(A|B)\)</span>是一个可逆且保持维度的映射，存在逆变换<span class="arithmatex">\(f^{−1}_\mathcal{A|B}(Z_{A|B} |B) = A|B\)</span>，其中<span class="arithmatex">\(f_\mathcal{A|B}\)</span>和<span class="arithmatex">\(f^{−1}_\mathcal{A|B}：\mathcal{A \times B} \mapsto \mathcal{A \times B}\)</span>。在变换过程中，<span class="arithmatex">\(B \in B\)</span>保持不变。在<span class="arithmatex">\(A\)</span>和<span class="arithmatex">\(B\)</span>独立假设的条件下，<span class="arithmatex">\(f_\mathcal{A|B}\)</span>的雅可比矩阵为：</p>
<div class="arithmatex">\[
\begin{aligned}
\frac{\partial f_\mathcal{A|B}}{\partial (A, B)}=\bigg[\begin{matrix}
\frac{\partial f_\mathcal{A|B}}{\partial A} &amp; \frac{\partial f_\mathcal{A|B}}{\partial B} \\ 0 &amp; \mathbb{1}_B \end{matrix}\bigg]
\end{aligned}
\]</div>
<p>在得到了的分布，便可以从中抽样，利用逆映射得到<span class="arithmatex">\(A|B\)</span>，并且利用雅克比矩阵给出<span class="arithmatex">\(A|B\)</span>的概率分布，条件变量变换公式的对数似然为：</p>
<div class="arithmatex">\[
\begin{aligned}
\log P_\mathcal{A|B}(A|B) = \log P_{\mathcal{Z}_\mathcal{A|B}}(Z_{A|B}) + \log |\det \frac{\partial f_\mathcal{A|B}}{\partial A}|
\end{aligned}
\]</div>
<p>和基于流的RealNVP、Glow模型一样，为了得到可逆映射，Moflow引入了图耦合层，对于每个图耦合层，沿着n行维度将输入<span class="arithmatex">\(A \in \mathbb{R}^{n×k}\)</span>分为两部分<span class="arithmatex">\(A = (A_1, A_2)\)</span>，然后按照以下方式得到输出<span class="arithmatex">\(Z_{A|B} = (Z_{A_1|B}, Z_{A_2|B}) = f_\mathcal{A|B}(A|B)\)</span>,将输入分割成两个部分<span class="arithmatex">\(A_1\)</span>和<span class="arithmatex">\(A_2\)</span>：</p>
<div class="arithmatex">\[
\begin{aligned}
Z_{A_1 |B} &amp;= A_1 \\
Z_{A_2 |B} &amp;= A_2 \odot \text{Sigmoid}(S_Θ(A_1 |B)) + T_Θ(A_1 |B)
\end{aligned}
\]</div>
<p>将上述式子求逆，即可得到<span class="arithmatex">\(A_1\)</span>和<span class="arithmatex">\(A_2\)</span>。图卷积层是利用关系图卷积网络（R-GCN）来完成的，具体操作如下：</p>
<div class="arithmatex">\[
\begin{aligned}
\text{graphconv}(A_1) &amp; = \sum_{i=1}^c \hat{B}_i (M \odot A)W_i + (M \odot A)W_0
\end{aligned}
\]</div>
<p>同时使用多个堆叠的图卷积-&gt;BatchNorm1d-&gt;ReLU层和一个多层感知机（MLP）输出层来构建图缩放函数<span class="arithmatex">\(S_Θ\)</span>和图变换函数<span class="arithmatex">\(T_Θ\)</span>。为了数值稳定性，在<span class="arithmatex">\(S_Θ\)</span>中采用了Sigmoid函数，实现级联多个流层时数值稳定。图耦合层的逆映射<span class="arithmatex">\(f^{-1}_\mathcal{A|B}\)</span>为：</p>
<div class="arithmatex">\[
\begin{aligned}
A_1 &amp;= Z_{A_1}|B \\
A_2 &amp;= (Z_{A_2}|B - T_Θ(Z_{A_1|B}|B)) / \text{Sigmoid}(S_Θ(Z_{A_1|B}|B))
\end{aligned}
\]</div>
<p>每个图耦合层的雅可比行列式的对数可以通过以下方式进行计算：</p>
<div class="arithmatex">\[
\begin{aligned}
\log | \det （\frac{\partial f_\mathcal{A|B}}{\partial A}）|= \sum_j \log \text{Sigmoid}(S_Θ(A_1|B))_j
\end{aligned}
\]</div>
<p>其中<span class="arithmatex">\(j\)</span>迭代每个元素。可以使用任意复杂的图卷积结构来构建<span class="arithmatex">\(S_Θ\)</span>和<span class="arithmatex">\(T_Θ\)</span>，因为上述<span class="arithmatex">\(f_\mathcal{A|B}\)</span>的雅可比行列式计算不涉及<span class="arithmatex">\(S_Θ\)</span>或<span class="arithmatex">\(T_Θ\)</span>的雅可比矩阵计算。</p>
<p>在学习原子表示的时候，为了保证数据稳定性，对于每一行维度使用<span class="arithmatex">\(\sigma^2 \in \mathbb{R}^{n \times 1}\)</span>进行归一化，使得输入经过归一化后的结果为<span class="arithmatex">\(\hat A = \frac{A - \mu} {\sqrt{\sigma^2 + \epsilon}}\)</span>，其中<span class="arithmatex">\(\epsilon\)</span>是一个小的常数。反向变换为<span class="arithmatex">\(A = \hat A \times \sqrt{\sigma^2 + \epsilon} + \mu\)</span>，并且对数雅可比行列式为：</p>
<div class="arithmatex">\[
\begin{aligned}
\log | \det \frac{\partial actnorm2D}{\partial X}| = \frac{k}{2}\sum_i^n | \log(\sigma^2_i + \epsilon) |
\end{aligned}
\]</div>
<p>在学习键的数据表示上，采用了基于Glow的思想，和上述学习原子表示的步骤相似，并且为了数据稳定性，同样引入了Glow模型中的<span class="arithmatex">\(1 \times 1\)</span>卷积操作。</p>
<p>最后是进行化学有效性验证，遵循每个原子的价键限制，采用原子和键组合后是否符合化学上键价的约束，定义了价键约束：</p>
<div class="arithmatex">\[
\begin{aligned}
\sum_{c,j}c \times B(c, i, j) \le \text{Valency}(\text{Atom}_i) + Ch
\end{aligned}
\]</div>
<p>其中，<span class="arithmatex">\(c\)</span>为键的类型（单键，双键，三键），与其他的模型不同，加入了形式电荷<span class="arithmatex">\(Ch\)</span>的约束，这种效应可能为带电原子引入额外的键。例如，铵[NH4]+的N可能具有4个键，而不是3。类似地，S+和O+的可能具有3个键而不是2。</p>
<p>模型结构如图所示：
</p><center class="img">
<a class="glightbox" href="https://paddle-org.bj.bcebos.com/paddlescience/docs/moflow.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img title="MoFlow的模型结构图" src="https://paddle-org.bj.bcebos.com/paddlescience/docs/moflow.jpg" width="80%"></a>MoFlow的模型结构图
</center>
<h2 id="3">3. 模型的实现<a class="headerlink" href="#3" title="Permanent link">¶</a></h2>
<p>接下来开始讲解如何基于 PaddleScience 代码，来实现药物分子中结构重构的模型复，为实现moflow的模型构建，训练、推理以及评估，接下来仅对模型构建、训练、测试、评估等关键步骤进行阐述，而其余细节请参考 <a href="../../api/arch/">API文档</a>。</p>
<h3 id="31">3.1 数据处理<a class="headerlink" href="#31" title="Permanent link">¶</a></h3>
<p>在数据处理中，首先通过读取化学分子结构，采用化学分子库的处理，将数据集中的化学结构部分进行化学键和分子节点的提取，对原子结构和键值进行处理，用 PaddleScience 代码表示如下</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">data/dataset/moflow_dataset.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-394">394</a></span>
<span class="normal"><a href="#__codelineno-3-395">395</a></span>
<span class="normal"><a href="#__codelineno-3-396">396</a></span>
<span class="normal"><a href="#__codelineno-3-397">397</a></span>
<span class="normal"><a href="#__codelineno-3-398">398</a></span>
<span class="normal"><a href="#__codelineno-3-399">399</a></span>
<span class="normal"><a href="#__codelineno-3-400">400</a></span>
<span class="normal"><a href="#__codelineno-3-401">401</a></span>
<span class="normal"><a href="#__codelineno-3-402">402</a></span>
<span class="normal"><a href="#__codelineno-3-403">403</a></span>
<span class="normal"><a href="#__codelineno-3-404">404</a></span>
<span class="normal"><a href="#__codelineno-3-405">405</a></span>
<span class="normal"><a href="#__codelineno-3-406">406</a></span>
<span class="normal"><a href="#__codelineno-3-407">407</a></span>
<span class="normal"><a href="#__codelineno-3-408">408</a></span>
<span class="normal"><a href="#__codelineno-3-409">409</a></span>
<span class="normal"><a href="#__codelineno-3-410">410</a></span>
<span class="normal"><a href="#__codelineno-3-411">411</a></span>
<span class="normal"><a href="#__codelineno-3-412">412</a></span>
<span class="normal"><a href="#__codelineno-3-413">413</a></span>
<span class="normal"><a href="#__codelineno-3-414">414</a></span>
<span class="normal"><a href="#__codelineno-3-415">415</a></span>
<span class="normal"><a href="#__codelineno-3-416">416</a></span>
<span class="normal"><a href="#__codelineno-3-417">417</a></span>
<span class="normal"><a href="#__codelineno-3-418">418</a></span>
<span class="normal"><a href="#__codelineno-3-419">419</a></span>
<span class="normal"><a href="#__codelineno-3-420">420</a></span>
<span class="normal"><a href="#__codelineno-3-421">421</a></span>
<span class="normal"><a href="#__codelineno-3-422">422</a></span>
<span class="normal"><a href="#__codelineno-3-423">423</a></span>
<span class="normal"><a href="#__codelineno-3-424">424</a></span>
<span class="normal"><a href="#__codelineno-3-425">425</a></span>
<span class="normal"><a href="#__codelineno-3-426">426</a></span>
<span class="normal"><a href="#__codelineno-3-427">427</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-394"><a id="__codelineno-3-394" name="__codelineno-3-394"></a>                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-3-395"><a id="__codelineno-3-395" name="__codelineno-3-395"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"parse(), type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-3-396"><a id="__codelineno-3-396" name="__codelineno-3-396"></a>                <span class="k">continue</span>
</span><span id="__span-3-397"><a id="__codelineno-3-397" name="__codelineno-3-397"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-3-398"><a id="__codelineno-3-398" name="__codelineno-3-398"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"parse(), type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="__span-3-399"><a id="__codelineno-3-399" name="__codelineno-3-399"></a>                <span class="n">fail_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-3-400"><a id="__codelineno-3-400" name="__codelineno-3-400"></a>                <span class="k">continue</span>
</span><span id="__span-3-401"><a id="__codelineno-3-401" name="__codelineno-3-401"></a>            <span class="c1"># raw_data = misc.convert_to_dict(np.array([nodes, edges]), self.input_keys)</span>
</span><span id="__span-3-402"><a id="__codelineno-3-402" name="__codelineno-3-402"></a>
</span><span id="__span-3-403"><a id="__codelineno-3-403" name="__codelineno-3-403"></a>            <span class="n">all_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
</span><span id="__span-3-404"><a id="__codelineno-3-404" name="__codelineno-3-404"></a>            <span class="n">all_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</span><span id="__span-3-405"><a id="__codelineno-3-405" name="__codelineno-3-405"></a>            <span class="c1"># inputs.append(raw_data)</span>
</span><span id="__span-3-406"><a id="__codelineno-3-406" name="__codelineno-3-406"></a>
</span><span id="__span-3-407"><a id="__codelineno-3-407" name="__codelineno-3-407"></a>            <span class="n">success_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-3-408"><a id="__codelineno-3-408" name="__codelineno-3-408"></a>
</span><span id="__span-3-409"><a id="__codelineno-3-409" name="__codelineno-3-409"></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="__span-3-410"><a id="__codelineno-3-410" name="__codelineno-3-410"></a>            <span class="p">[</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">label_col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_keys</span><span class="p">)]</span>
</span><span id="__span-3-411"><a id="__codelineno-3-411" name="__codelineno-3-411"></a>        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="__span-3-412"><a id="__codelineno-3-412" name="__codelineno-3-412"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_edges</span><span class="p">)],</span> <span class="n">labels</span>
</span><span id="__span-3-413"><a id="__codelineno-3-413" name="__codelineno-3-413"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
</span><span id="__span-3-414"><a id="__codelineno-3-414" name="__codelineno-3-414"></a>            <span class="sa">f</span><span class="s2">"Preprocess finished. FAIL </span><span class="si">{</span><span class="n">fail_count</span><span class="si">}</span><span class="s2">, "</span>
</span><span id="__span-3-415"><a id="__codelineno-3-415" name="__codelineno-3-415"></a>            <span class="sa">f</span><span class="s2">"SUCCESS </span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="s2">, TOTAL </span><span class="si">{</span><span class="n">total_count</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-3-416"><a id="__codelineno-3-416" name="__codelineno-3-416"></a>        <span class="p">)</span>
</span><span id="__span-3-417"><a id="__codelineno-3-417" name="__codelineno-3-417"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-3-418"><a id="__codelineno-3-418" name="__codelineno-3-418"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="__span-3-419"><a id="__codelineno-3-419" name="__codelineno-3-419"></a>
</span><span id="__span-3-420"><a id="__codelineno-3-420" name="__codelineno-3-420"></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-3-421"><a id="__codelineno-3-421" name="__codelineno-3-421"></a>
</span><span id="__span-3-422"><a id="__codelineno-3-422" name="__codelineno-3-422"></a><span class="k">def</span> <span class="nf">transform_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">):</span>
</span><span id="__span-3-423"><a id="__codelineno-3-423" name="__codelineno-3-423"></a>    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-3-424"><a id="__codelineno-3-424" name="__codelineno-3-424"></a>    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
</span><span id="__span-3-425"><a id="__codelineno-3-425" name="__codelineno-3-425"></a>    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
</span><span id="__span-3-426"><a id="__codelineno-3-426" name="__codelineno-3-426"></a>        <span class="n">input_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="__span-3-427"><a id="__codelineno-3-427" name="__codelineno-3-427"></a>        <span class="n">label_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">label_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span></code></pre></div></td></tr></table></div>
<p>训练数据采用集合标签进行选择，将数据集分成训练数据和测试数据，其中qm9和zinc250k数据集处理一致，对于其特征和原子结构的处理选择上有些差异。</p>
<h3 id="32">3.2 约束构建<a class="headerlink" href="#32" title="Permanent link">¶</a></h3>
<p>本案例基于数据从中学习化学键约束的方法求解问题，因此按照 PaddleScience 的API结构说明，采用内置的 SupervisedConstraint 构建监督约束。在定义约束之前，需要首先指定监督约束中用于数据加载的各个参数。</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/moflow_train.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-140">140</a></span>
<span class="normal"><a href="#__codelineno-4-141">141</a></span>
<span class="normal"><a href="#__codelineno-4-142">142</a></span>
<span class="normal"><a href="#__codelineno-4-143">143</a></span>
<span class="normal"><a href="#__codelineno-4-144">144</a></span>
<span class="normal"><a href="#__codelineno-4-145">145</a></span>
<span class="normal"><a href="#__codelineno-4-146">146</a></span>
<span class="normal"><a href="#__codelineno-4-147">147</a></span>
<span class="normal"><a href="#__codelineno-4-148">148</a></span>
<span class="normal"><a href="#__codelineno-4-149">149</a></span>
<span class="normal"><a href="#__codelineno-4-150">150</a></span>
<span class="normal"><a href="#__codelineno-4-151">151</a></span>
<span class="normal"><a href="#__codelineno-4-152">152</a></span>
<span class="normal"><a href="#__codelineno-4-153">153</a></span>
<span class="normal"><a href="#__codelineno-4-154">154</a></span>
<span class="normal"><a href="#__codelineno-4-155">155</a></span>
<span class="normal"><a href="#__codelineno-4-156">156</a></span>
<span class="normal"><a href="#__codelineno-4-157">157</a></span>
<span class="normal"><a href="#__codelineno-4-158">158</a></span>
<span class="normal"><a href="#__codelineno-4-159">159</a></span>
<span class="normal"><a href="#__codelineno-4-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-140"><a id="__codelineno-4-140" name="__codelineno-4-140"></a><span class="c1"># set train dataloader config</span>
</span><span id="__span-4-141"><a id="__codelineno-4-141" name="__codelineno-4-141"></a><span class="n">train_dataloader_cfg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-142"><a id="__codelineno-4-142" name="__codelineno-4-142"></a>    <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-143"><a id="__codelineno-4-143" name="__codelineno-4-143"></a>        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"MOlFLOWDataset"</span><span class="p">,</span>
</span><span id="__span-4-144"><a id="__codelineno-4-144" name="__codelineno-4-144"></a>        <span class="s2">"file_path"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span>
</span><span id="__span-4-145"><a id="__codelineno-4-145" name="__codelineno-4-145"></a>        <span class="s2">"data_name"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-4-146"><a id="__codelineno-4-146" name="__codelineno-4-146"></a>        <span class="s2">"mode"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
</span><span id="__span-4-147"><a id="__codelineno-4-147" name="__codelineno-4-147"></a>        <span class="s2">"valid_idx"</span><span class="p">:</span> <span class="n">valid_idx</span><span class="p">,</span>
</span><span id="__span-4-148"><a id="__codelineno-4-148" name="__codelineno-4-148"></a>        <span class="s2">"input_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">input_keys</span><span class="p">,</span>
</span><span id="__span-4-149"><a id="__codelineno-4-149" name="__codelineno-4-149"></a>        <span class="s2">"label_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">label_keys</span><span class="p">,</span>
</span><span id="__span-4-150"><a id="__codelineno-4-150" name="__codelineno-4-150"></a>        <span class="s2">"smiles_col"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
</span><span id="__span-4-151"><a id="__codelineno-4-151" name="__codelineno-4-151"></a>        <span class="s2">"transform_fn"</span><span class="p">:</span> <span class="n">transform_fn</span><span class="p">,</span>
</span><span id="__span-4-152"><a id="__codelineno-4-152" name="__codelineno-4-152"></a>    <span class="p">},</span>
</span><span id="__span-4-153"><a id="__codelineno-4-153" name="__codelineno-4-153"></a>    <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-4-154"><a id="__codelineno-4-154" name="__codelineno-4-154"></a>        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-4-155"><a id="__codelineno-4-155" name="__codelineno-4-155"></a>        <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-4-156"><a id="__codelineno-4-156" name="__codelineno-4-156"></a>        <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-4-157"><a id="__codelineno-4-157" name="__codelineno-4-157"></a>    <span class="p">},</span>
</span><span id="__span-4-158"><a id="__codelineno-4-158" name="__codelineno-4-158"></a>    <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-4-159"><a id="__codelineno-4-159" name="__codelineno-4-159"></a>    <span class="s2">"num_workers"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
</span><span id="__span-4-160"><a id="__codelineno-4-160" name="__codelineno-4-160"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>其中，"dataset" 字段定义了使用的 <code>Dataset</code> 类名为 <code>MOlFLOWDataset</code>，"sampler" 字段定义了使用的 <code>Sampler</code> 类名为 <code>BatchSampler</code>，设置的 <code>batch_size</code> 为 256，<code>num_works</code> 为 8。</p>
<p>定义监督约束的代码如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/moflow_train.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-167">167</a></span>
<span class="normal"><a href="#__codelineno-5-168">168</a></span>
<span class="normal"><a href="#__codelineno-5-169">169</a></span>
<span class="normal"><a href="#__codelineno-5-170">170</a></span>
<span class="normal"><a href="#__codelineno-5-171">171</a></span>
<span class="normal"><a href="#__codelineno-5-172">172</a></span>
<span class="normal"><a href="#__codelineno-5-173">173</a></span>
<span class="normal"><a href="#__codelineno-5-174">174</a></span>
<span class="normal"><a href="#__codelineno-5-175">175</a></span>
<span class="normal"><a href="#__codelineno-5-176">176</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-167"><a id="__codelineno-5-167" name="__codelineno-5-167"></a><span class="c1"># set constraint</span>
</span><span id="__span-5-168"><a id="__codelineno-5-168" name="__codelineno-5-168"></a><span class="n">output_keys</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">output_keys</span>
</span><span id="__span-5-169"><a id="__codelineno-5-169" name="__codelineno-5-169"></a><span class="n">sup_constraint</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-5-170"><a id="__codelineno-5-170" name="__codelineno-5-170"></a>    <span class="n">train_dataloader_cfg</span><span class="p">,</span>
</span><span id="__span-5-171"><a id="__codelineno-5-171" name="__codelineno-5-171"></a>    <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">log_prob_loss</span><span class="p">),</span>
</span><span id="__span-5-172"><a id="__codelineno-5-172" name="__codelineno-5-172"></a>    <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">out</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">key</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output_keys</span><span class="p">},</span>
</span><span id="__span-5-173"><a id="__codelineno-5-173" name="__codelineno-5-173"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">"Sup_constraint"</span><span class="p">,</span>
</span><span id="__span-5-174"><a id="__codelineno-5-174" name="__codelineno-5-174"></a><span class="p">)</span>
</span><span id="__span-5-175"><a id="__codelineno-5-175" name="__codelineno-5-175"></a>
</span><span id="__span-5-176"><a id="__codelineno-5-176" name="__codelineno-5-176"></a><span class="n">constraint</span> <span class="o">=</span> <span class="p">{</span><span class="n">sup_constraint</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_constraint</span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="33">3.3 模型构建<a class="headerlink" href="#33" title="Permanent link">¶</a></h3>
<p>在该案例中，药物分子预测生成模型基于 MoFlowNet 网络模型实现，结合 PaddleScience 代码标准格式，对于模型进行分装，单独对flow，grow等模模型进行调用，其中模型构成的代码表示如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/moflow_train.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-162">162</a></span>
<span class="normal"><a href="#__codelineno-6-163">163</a></span>
<span class="normal"><a href="#__codelineno-6-164">164</a></span>
<span class="normal"><a href="#__codelineno-6-165">165</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-162"><a id="__codelineno-6-162" name="__codelineno-6-162"></a><span class="c1"># set model</span>
</span><span id="__span-6-163"><a id="__codelineno-6-163" name="__codelineno-6-163"></a><span class="n">model_cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="p">)</span>
</span><span id="__span-6-164"><a id="__codelineno-6-164" name="__codelineno-6-164"></a><span class="n">model_cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"hyper_params"</span><span class="p">:</span> <span class="n">model_params</span><span class="p">})</span>
</span><span id="__span-6-165"><a id="__codelineno-6-165" name="__codelineno-6-165"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">MoFlowNet</span><span class="p">(</span><span class="o">**</span><span class="n">model_cfg</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>模型网络参数配置如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/moflow_train.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-7-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-7-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-7-100">100</a></span>
<span class="normal"><a href="#__codelineno-7-101">101</a></span>
<span class="normal"><a href="#__codelineno-7-102">102</a></span>
<span class="normal"><a href="#__codelineno-7-103">103</a></span>
<span class="normal"><a href="#__codelineno-7-104">104</a></span>
<span class="normal"><a href="#__codelineno-7-105">105</a></span>
<span class="normal"><a href="#__codelineno-7-106">106</a></span>
<span class="normal"><a href="#__codelineno-7-107">107</a></span>
<span class="normal"><a href="#__codelineno-7-108">108</a></span>
<span class="normal"><a href="#__codelineno-7-109">109</a></span>
<span class="normal"><a href="#__codelineno-7-110">110</a></span>
<span class="normal"><a href="#__codelineno-7-111">111</a></span>
<span class="normal"><a href="#__codelineno-7-112">112</a></span>
<span class="normal"><a href="#__codelineno-7-113">113</a></span>
<span class="normal"><a href="#__codelineno-7-114">114</a></span>
<span class="normal"><a href="#__codelineno-7-115">115</a></span>
<span class="normal"><a href="#__codelineno-7-116">116</a></span>
<span class="normal"><a href="#__codelineno-7-117">117</a></span>
<span class="normal"><a href="#__codelineno-7-118">118</a></span>
<span class="normal"><a href="#__codelineno-7-119">119</a></span>
<span class="normal"><a href="#__codelineno-7-120">120</a></span>
<span class="normal"><a href="#__codelineno-7-121">121</a></span>
<span class="normal"><a href="#__codelineno-7-122">122</a></span>
<span class="normal"><a href="#__codelineno-7-123">123</a></span>
<span class="normal"><a href="#__codelineno-7-124">124</a></span>
<span class="normal"><a href="#__codelineno-7-125">125</a></span>
<span class="normal"><a href="#__codelineno-7-126">126</a></span>
<span class="normal"><a href="#__codelineno-7-127">127</a></span>
<span class="normal"><a href="#__codelineno-7-128">128</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-97"><a id="__codelineno-7-97" name="__codelineno-7-97"></a><span class="c1"># set training hyper-parameters</span>
</span><span id="__span-7-98"><a id="__codelineno-7-98" name="__codelineno-7-98"></a><span class="n">b_hidden_ch</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_hidden_ch</span>
</span><span id="__span-7-99"><a id="__codelineno-7-99" name="__codelineno-7-99"></a><span class="n">a_hidden_gnn</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_hidden_gnn</span>
</span><span id="__span-7-100"><a id="__codelineno-7-100" name="__codelineno-7-100"></a><span class="n">a_hidden_lin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_hidden_lin</span>
</span><span id="__span-7-101"><a id="__codelineno-7-101" name="__codelineno-7-101"></a><span class="n">mask_row_size_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">mask_row_size_list</span><span class="p">)</span>
</span><span id="__span-7-102"><a id="__codelineno-7-102" name="__codelineno-7-102"></a><span class="n">mask_row_stride_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">mask_row_stride_list</span><span class="p">)</span>
</span><span id="__span-7-103"><a id="__codelineno-7-103" name="__codelineno-7-103"></a><span class="n">a_n_type</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-7-104"><a id="__codelineno-7-104" name="__codelineno-7-104"></a><span class="n">atomic_num_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-7-105"><a id="__codelineno-7-105" name="__codelineno-7-105"></a>
</span><span id="__span-7-106"><a id="__codelineno-7-106" name="__codelineno-7-106"></a><span class="n">model_params</span> <span class="o">=</span> <span class="n">Hyperparameters</span><span class="p">(</span>
</span><span id="__span-7-107"><a id="__codelineno-7-107" name="__codelineno-7-107"></a>    <span class="n">b_n_type</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_n_type</span><span class="p">,</span>
</span><span id="__span-7-108"><a id="__codelineno-7-108" name="__codelineno-7-108"></a>    <span class="n">b_n_flow</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_n_flow</span><span class="p">,</span>
</span><span id="__span-7-109"><a id="__codelineno-7-109" name="__codelineno-7-109"></a>    <span class="n">b_n_block</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_n_block</span><span class="p">,</span>
</span><span id="__span-7-110"><a id="__codelineno-7-110" name="__codelineno-7-110"></a>    <span class="n">b_n_squeeze</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_n_squeeze</span><span class="p">,</span>
</span><span id="__span-7-111"><a id="__codelineno-7-111" name="__codelineno-7-111"></a>    <span class="n">b_hidden_ch</span><span class="o">=</span><span class="n">b_hidden_ch</span><span class="p">,</span>
</span><span id="__span-7-112"><a id="__codelineno-7-112" name="__codelineno-7-112"></a>    <span class="n">b_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-7-113"><a id="__codelineno-7-113" name="__codelineno-7-113"></a>    <span class="n">b_conv_lu</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_conv_lu</span><span class="p">,</span>
</span><span id="__span-7-114"><a id="__codelineno-7-114" name="__codelineno-7-114"></a>    <span class="n">a_n_node</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_n_node</span><span class="p">,</span>
</span><span id="__span-7-115"><a id="__codelineno-7-115" name="__codelineno-7-115"></a>    <span class="n">a_n_type</span><span class="o">=</span><span class="n">a_n_type</span><span class="p">,</span>
</span><span id="__span-7-116"><a id="__codelineno-7-116" name="__codelineno-7-116"></a>    <span class="n">a_hidden_gnn</span><span class="o">=</span><span class="n">a_hidden_gnn</span><span class="p">,</span>
</span><span id="__span-7-117"><a id="__codelineno-7-117" name="__codelineno-7-117"></a>    <span class="n">a_hidden_lin</span><span class="o">=</span><span class="n">a_hidden_lin</span><span class="p">,</span>
</span><span id="__span-7-118"><a id="__codelineno-7-118" name="__codelineno-7-118"></a>    <span class="n">a_n_flow</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_n_flow</span><span class="p">,</span>
</span><span id="__span-7-119"><a id="__codelineno-7-119" name="__codelineno-7-119"></a>    <span class="n">a_n_block</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_n_block</span><span class="p">,</span>
</span><span id="__span-7-120"><a id="__codelineno-7-120" name="__codelineno-7-120"></a>    <span class="n">mask_row_size_list</span><span class="o">=</span><span class="n">mask_row_size_list</span><span class="p">,</span>
</span><span id="__span-7-121"><a id="__codelineno-7-121" name="__codelineno-7-121"></a>    <span class="n">mask_row_stride_list</span><span class="o">=</span><span class="n">mask_row_stride_list</span><span class="p">,</span>
</span><span id="__span-7-122"><a id="__codelineno-7-122" name="__codelineno-7-122"></a>    <span class="n">a_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-7-123"><a id="__codelineno-7-123" name="__codelineno-7-123"></a>    <span class="n">learn_dist</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">learn_dist</span><span class="p">,</span>
</span><span id="__span-7-124"><a id="__codelineno-7-124" name="__codelineno-7-124"></a>    <span class="n">seed</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="__span-7-125"><a id="__codelineno-7-125" name="__codelineno-7-125"></a>    <span class="n">noise_scale</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">noise_scale</span><span class="p">,</span>
</span><span id="__span-7-126"><a id="__codelineno-7-126" name="__codelineno-7-126"></a><span class="p">)</span>
</span><span id="__span-7-127"><a id="__codelineno-7-127" name="__codelineno-7-127"></a>
</span><span id="__span-7-128"><a id="__codelineno-7-128" name="__codelineno-7-128"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Model params:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">print</span><span class="p">()))</span>
</span></code></pre></div></td></tr></table></div>
<p>参数通过配置文件进行设置如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/conf/moflow_train.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span>
<span class="normal"><a href="#__codelineno-8-34">34</a></span>
<span class="normal"><a href="#__codelineno-8-35">35</a></span>
<span class="normal"><a href="#__codelineno-8-36">36</a></span>
<span class="normal"><a href="#__codelineno-8-37">37</a></span>
<span class="normal"><a href="#__codelineno-8-38">38</a></span>
<span class="normal"><a href="#__codelineno-8-39">39</a></span>
<span class="normal"><a href="#__codelineno-8-40">40</a></span>
<span class="normal"><a href="#__codelineno-8-41">41</a></span>
<span class="normal"><a href="#__codelineno-8-42">42</a></span>
<span class="normal"><a href="#__codelineno-8-43">43</a></span>
<span class="normal"><a href="#__codelineno-8-44">44</a></span>
<span class="normal"><a href="#__codelineno-8-45">45</a></span>
<span class="normal"><a href="#__codelineno-8-46">46</a></span>
<span class="normal"><a href="#__codelineno-8-47">47</a></span>
<span class="normal"><a href="#__codelineno-8-48">48</a></span>
<span class="normal"><a href="#__codelineno-8-49">49</a></span>
<span class="normal"><a href="#__codelineno-8-50">50</a></span>
<span class="normal"><a href="#__codelineno-8-51">51</a></span>
<span class="normal"><a href="#__codelineno-8-52">52</a></span>
<span class="normal"><a href="#__codelineno-8-53">53</a></span>
<span class="normal"><a href="#__codelineno-8-54">54</a></span>
<span class="normal"><a href="#__codelineno-8-55">55</a></span>
<span class="normal"><a href="#__codelineno-8-56">56</a></span>
<span class="normal"><a href="#__codelineno-8-57">57</a></span>
<span class="normal"><a href="#__codelineno-8-58">58</a></span>
<span class="normal"><a href="#__codelineno-8-59">59</a></span>
<span class="normal"><a href="#__codelineno-8-60">60</a></span>
<span class="normal"><a href="#__codelineno-8-61">61</a></span>
<span class="normal"><a href="#__codelineno-8-62">62</a></span>
<span class="normal"><a href="#__codelineno-8-63">63</a></span>
<span class="normal"><a href="#__codelineno-8-64">64</a></span>
<span class="normal"><a href="#__codelineno-8-65">65</a></span>
<span class="normal"><a href="#__codelineno-8-66">66</a></span>
<span class="normal"><a href="#__codelineno-8-67">67</a></span>
<span class="normal"><a href="#__codelineno-8-68">68</a></span>
<span class="normal"><a href="#__codelineno-8-69">69</a></span>
<span class="normal"><a href="#__codelineno-8-70">70</a></span>
<span class="normal"><a href="#__codelineno-8-71">71</a></span>
<span class="normal"><a href="#__codelineno-8-72">72</a></span>
<span class="normal"><a href="#__codelineno-8-73">73</a></span>
<span class="normal"><a href="#__codelineno-8-74">74</a></span>
<span class="normal"><a href="#__codelineno-8-75">75</a></span>
<span class="normal"><a href="#__codelineno-8-76">76</a></span>
<span class="normal"><a href="#__codelineno-8-77">77</a></span>
<span class="normal"><a href="#__codelineno-8-78">78</a></span>
<span class="normal"><a href="#__codelineno-8-79">79</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="c1"># general settings</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="n">mode</span><span class="p">:</span> <span class="n">train</span> <span class="c1"># running mode: train/eval</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="n">data_name</span><span class="p">:</span> <span class="n">qm9</span> <span class="c1"># data select:qm9/zinc250k</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="n">seed</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="n">output_dir</span><span class="p">:</span> <span class="err">$</span><span class="p">{</span><span class="n">hydra</span><span class="p">:</span><span class="n">run</span><span class="o">.</span><span class="n">dir</span><span class="p">}</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="n">log_freq</span><span class="p">:</span> <span class="mi">20</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28"></a>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="c1"># set training hyper-parameters</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="n">qm9</span><span class="p">:</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31"></a>  <span class="n">b_n_flow</span><span class="p">:</span> <span class="mi">10</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32"></a>  <span class="n">b_n_block</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33"></a>  <span class="n">b_hidden_ch</span><span class="p">:</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">]</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34"></a>  <span class="n">a_n_flow</span><span class="p">:</span> <span class="mi">27</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35"></a>  <span class="n">a_n_block</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36"></a>  <span class="n">a_hidden_gnn</span><span class="p">:</span> <span class="p">[</span><span class="mi">64</span><span class="p">]</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37"></a>  <span class="n">a_hidden_lin</span><span class="p">:</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">64</span><span class="p">]</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38"></a>  <span class="n">mask_row_size_list</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39"></a>  <span class="n">mask_row_stride_list</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40"></a>  <span class="n">learn_dist</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41"></a>  <span class="n">noise_scale</span><span class="p">:</span> <span class="mf">0.6</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42"></a>  <span class="n">b_conv_lu</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43"></a>  <span class="n">atomic_num_list</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44"></a>  <span class="n">b_n_type</span><span class="p">:</span> <span class="mi">4</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45"></a>  <span class="n">b_n_squeeze</span><span class="p">:</span> <span class="mi">3</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46"></a>  <span class="n">a_n_node</span><span class="p">:</span> <span class="mi">9</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47"></a>  <span class="n">valid_idx</span><span class="p">:</span> <span class="n">valid_idx_qm9</span><span class="o">.</span><span class="n">json</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48"></a>  <span class="n">label_keys</span><span class="p">:</span> <span class="p">[</span><span class="s1">'A'</span><span class="p">,</span> <span class="s1">'B'</span><span class="p">,</span> <span class="s1">'C'</span><span class="p">,</span> <span class="s1">'mu'</span><span class="p">,</span> <span class="s1">'alpha'</span><span class="p">,</span> <span class="s1">'homo'</span><span class="p">,</span> <span class="s1">'lumo'</span><span class="p">,</span> <span class="s1">'gap'</span><span class="p">,</span> <span class="s1">'r2'</span><span class="p">,</span> <span class="s1">'zpve'</span><span class="p">,</span> <span class="s1">'U0'</span><span class="p">,</span> <span class="s1">'U'</span><span class="p">,</span> <span class="s1">'H'</span><span class="p">,</span> <span class="s1">'G'</span><span class="p">,</span> <span class="s1">'Cv'</span><span class="p">]</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49"></a>  <span class="n">smiles_col</span><span class="p">:</span> <span class="n">SMILES1</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50"></a>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51"></a><span class="n">zinc250k</span><span class="p">:</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52"></a>  <span class="n">b_n_flow</span><span class="p">:</span> <span class="mi">10</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53"></a>  <span class="n">b_n_block</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54"></a>  <span class="n">b_hidden_ch</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">512</span><span class="p">]</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55"></a>  <span class="n">a_n_flow</span><span class="p">:</span> <span class="mi">38</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56"></a>  <span class="n">a_n_block</span><span class="p">:</span> <span class="mi">1</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57"></a>  <span class="n">a_hidden_gnn</span><span class="p">:</span> <span class="p">[</span><span class="mi">256</span><span class="p">]</span>
</span><span id="__span-8-58"><a id="__codelineno-8-58" name="__codelineno-8-58"></a>  <span class="n">a_hidden_lin</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span><span class="mi">64</span><span class="p">]</span>
</span><span id="__span-8-59"><a id="__codelineno-8-59" name="__codelineno-8-59"></a>  <span class="n">mask_row_size_list</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-8-60"><a id="__codelineno-8-60" name="__codelineno-8-60"></a>  <span class="n">mask_row_stride_list</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="__span-8-61"><a id="__codelineno-8-61" name="__codelineno-8-61"></a>  <span class="n">learn_dist</span><span class="p">:</span> <span class="kc">True</span>
</span><span id="__span-8-62"><a id="__codelineno-8-62" name="__codelineno-8-62"></a>  <span class="n">noise_scale</span><span class="p">:</span> <span class="mf">0.6</span>
</span><span id="__span-8-63"><a id="__codelineno-8-63" name="__codelineno-8-63"></a>  <span class="n">b_conv_lu</span><span class="p">:</span> <span class="mi">2</span>
</span><span id="__span-8-64"><a id="__codelineno-8-64" name="__codelineno-8-64"></a>  <span class="n">atomic_num_list</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="__span-8-65"><a id="__codelineno-8-65" name="__codelineno-8-65"></a>  <span class="n">b_n_type</span><span class="p">:</span> <span class="mi">4</span>
</span><span id="__span-8-66"><a id="__codelineno-8-66" name="__codelineno-8-66"></a>  <span class="n">b_n_squeeze</span><span class="p">:</span> <span class="mi">19</span>
</span><span id="__span-8-67"><a id="__codelineno-8-67" name="__codelineno-8-67"></a>  <span class="n">a_n_node</span><span class="p">:</span> <span class="mi">38</span>
</span><span id="__span-8-68"><a id="__codelineno-8-68" name="__codelineno-8-68"></a>  <span class="n">valid_idx</span><span class="p">:</span> <span class="n">valid_idx_zinc</span><span class="o">.</span><span class="n">json</span>
</span><span id="__span-8-69"><a id="__codelineno-8-69" name="__codelineno-8-69"></a>  <span class="n">label_keys</span><span class="p">:</span> <span class="p">[</span><span class="s1">'logP'</span><span class="p">,</span> <span class="s1">'qed'</span><span class="p">,</span> <span class="s1">'SAS'</span><span class="p">]</span>
</span><span id="__span-8-70"><a id="__codelineno-8-70" name="__codelineno-8-70"></a>  <span class="n">smiles_col</span><span class="p">:</span> <span class="n">smiles</span>
</span><span id="__span-8-71"><a id="__codelineno-8-71" name="__codelineno-8-71"></a>
</span><span id="__span-8-72"><a id="__codelineno-8-72" name="__codelineno-8-72"></a><span class="c1"># set data path</span>
</span><span id="__span-8-73"><a id="__codelineno-8-73" name="__codelineno-8-73"></a><span class="n">FILE_PATH</span><span class="p">:</span> <span class="o">./</span><span class="n">datasets</span><span class="o">/</span><span class="n">moflow</span>
</span><span id="__span-8-74"><a id="__codelineno-8-74" name="__codelineno-8-74"></a>
</span><span id="__span-8-75"><a id="__codelineno-8-75" name="__codelineno-8-75"></a><span class="c1"># model settings</span>
</span><span id="__span-8-76"><a id="__codelineno-8-76" name="__codelineno-8-76"></a><span class="n">MODEL</span><span class="p">:</span>
</span><span id="__span-8-77"><a id="__codelineno-8-77" name="__codelineno-8-77"></a>  <span class="n">input_keys</span><span class="p">:</span> <span class="p">[</span><span class="s2">"nodes"</span><span class="p">,</span> <span class="s2">"edges"</span><span class="p">]</span>
</span><span id="__span-8-78"><a id="__codelineno-8-78" name="__codelineno-8-78"></a>  <span class="n">output_keys</span><span class="p">:</span> <span class="p">[</span><span class="s2">"output"</span><span class="p">,</span> <span class="s2">"sum_log_det"</span><span class="p">]</span>
</span><span id="__span-8-79"><a id="__codelineno-8-79" name="__codelineno-8-79"></a>  <span class="n">hyper_params</span><span class="p">:</span> <span class="n">null</span>
</span></code></pre></div></td></tr></table></div>
<p>其中，data_name表示数据集的选择，选择之后对应选择不同数据集对应的网络参数部分，input_keys 和 output_keys 分别代表网络模型输入、输出变量的名称,hyper_params代表不同数据集对应的网络参数，在数据集选择之后模型构建中会进行更新，方便不同数据集下模型的统一构建。使用模型自定义的损失函数模型的训练。</p>
<h3 id="34">3.4 学习率与优化器构建<a class="headerlink" href="#34" title="Permanent link">¶</a></h3>
<p>本案例中使用的学习率大小设置为 <code>0.001</code>。优化器使用 <code>Adam</code>,用 PaddleScience 代码表示如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/moflow_train.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-181">181</a></span>
<span class="normal"><a href="#__codelineno-9-182">182</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-181"><a id="__codelineno-9-181" name="__codelineno-9-181"></a><span class="c1"># init optimizer and lr scheduler</span>
</span><span id="__span-9-182"><a id="__codelineno-9-182" name="__codelineno-9-182"></a><span class="n">optimizer</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="35">3.5 评估器构建<a class="headerlink" href="#35" title="Permanent link">¶</a></h3>
<p>本案例训练过程中会按照一定的训练轮数间隔，使用验证集评估当前模型的训练情况，需要使用 <code>SupervisedValidator</code> 构建评估器。代码如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/moflow_train.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-184">184</a></span>
<span class="normal"><a href="#__codelineno-10-185">185</a></span>
<span class="normal"><a href="#__codelineno-10-186">186</a></span>
<span class="normal"><a href="#__codelineno-10-187">187</a></span>
<span class="normal"><a href="#__codelineno-10-188">188</a></span>
<span class="normal"><a href="#__codelineno-10-189">189</a></span>
<span class="normal"><a href="#__codelineno-10-190">190</a></span>
<span class="normal"><a href="#__codelineno-10-191">191</a></span>
<span class="normal"><a href="#__codelineno-10-192">192</a></span>
<span class="normal"><a href="#__codelineno-10-193">193</a></span>
<span class="normal"><a href="#__codelineno-10-194">194</a></span>
<span class="normal"><a href="#__codelineno-10-195">195</a></span>
<span class="normal"><a href="#__codelineno-10-196">196</a></span>
<span class="normal"><a href="#__codelineno-10-197">197</a></span>
<span class="normal"><a href="#__codelineno-10-198">198</a></span>
<span class="normal"><a href="#__codelineno-10-199">199</a></span>
<span class="normal"><a href="#__codelineno-10-200">200</a></span>
<span class="normal"><a href="#__codelineno-10-201">201</a></span>
<span class="normal"><a href="#__codelineno-10-202">202</a></span>
<span class="normal"><a href="#__codelineno-10-203">203</a></span>
<span class="normal"><a href="#__codelineno-10-204">204</a></span>
<span class="normal"><a href="#__codelineno-10-205">205</a></span>
<span class="normal"><a href="#__codelineno-10-206">206</a></span>
<span class="normal"><a href="#__codelineno-10-207">207</a></span>
<span class="normal"><a href="#__codelineno-10-208">208</a></span>
<span class="normal"><a href="#__codelineno-10-209">209</a></span>
<span class="normal"><a href="#__codelineno-10-210">210</a></span>
<span class="normal"><a href="#__codelineno-10-211">211</a></span>
<span class="normal"><a href="#__codelineno-10-212">212</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-184"><a id="__codelineno-10-184" name="__codelineno-10-184"></a><span class="c1"># set eval dataloader config</span>
</span><span id="__span-10-185"><a id="__codelineno-10-185" name="__codelineno-10-185"></a><span class="n">eval_dataloader_cfg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-10-186"><a id="__codelineno-10-186" name="__codelineno-10-186"></a>    <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-10-187"><a id="__codelineno-10-187" name="__codelineno-10-187"></a>        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"MOlFLOWDataset"</span><span class="p">,</span>
</span><span id="__span-10-188"><a id="__codelineno-10-188" name="__codelineno-10-188"></a>        <span class="s2">"file_path"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span>
</span><span id="__span-10-189"><a id="__codelineno-10-189" name="__codelineno-10-189"></a>        <span class="s2">"data_name"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-10-190"><a id="__codelineno-10-190" name="__codelineno-10-190"></a>        <span class="s2">"mode"</span><span class="p">:</span> <span class="s2">"eval"</span><span class="p">,</span>
</span><span id="__span-10-191"><a id="__codelineno-10-191" name="__codelineno-10-191"></a>        <span class="s2">"valid_idx"</span><span class="p">:</span> <span class="n">valid_idx</span><span class="p">,</span>
</span><span id="__span-10-192"><a id="__codelineno-10-192" name="__codelineno-10-192"></a>        <span class="s2">"input_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">input_keys</span><span class="p">,</span>
</span><span id="__span-10-193"><a id="__codelineno-10-193" name="__codelineno-10-193"></a>        <span class="s2">"label_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">label_keys</span><span class="p">,</span>
</span><span id="__span-10-194"><a id="__codelineno-10-194" name="__codelineno-10-194"></a>        <span class="s2">"smiles_col"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
</span><span id="__span-10-195"><a id="__codelineno-10-195" name="__codelineno-10-195"></a>        <span class="s2">"transform_fn"</span><span class="p">:</span> <span class="n">transform_fn</span><span class="p">,</span>
</span><span id="__span-10-196"><a id="__codelineno-10-196" name="__codelineno-10-196"></a>    <span class="p">},</span>
</span><span id="__span-10-197"><a id="__codelineno-10-197" name="__codelineno-10-197"></a>    <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-10-198"><a id="__codelineno-10-198" name="__codelineno-10-198"></a><span class="p">}</span>
</span><span id="__span-10-199"><a id="__codelineno-10-199" name="__codelineno-10-199"></a>
</span><span id="__span-10-200"><a id="__codelineno-10-200" name="__codelineno-10-200"></a><span class="c1"># set validator</span>
</span><span id="__span-10-201"><a id="__codelineno-10-201" name="__codelineno-10-201"></a><span class="n">sup_validator</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">SupervisedValidator</span><span class="p">(</span>
</span><span id="__span-10-202"><a id="__codelineno-10-202" name="__codelineno-10-202"></a>    <span class="n">eval_dataloader_cfg</span><span class="p">,</span>
</span><span id="__span-10-203"><a id="__codelineno-10-203" name="__codelineno-10-203"></a>    <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">log_prob_loss</span><span class="p">),</span>
</span><span id="__span-10-204"><a id="__codelineno-10-204" name="__codelineno-10-204"></a>    <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">out</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">key</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output_keys</span><span class="p">},</span>
</span><span id="__span-10-205"><a id="__codelineno-10-205" name="__codelineno-10-205"></a>    <span class="n">metric</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-10-206"><a id="__codelineno-10-206" name="__codelineno-10-206"></a>        <span class="s2">"Valid"</span><span class="p">:</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">FunctionalMetric</span><span class="p">(</span>
</span><span id="__span-10-207"><a id="__codelineno-10-207" name="__codelineno-10-207"></a>            <span class="n">eval_func</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-10-208"><a id="__codelineno-10-208" name="__codelineno-10-208"></a>        <span class="p">)</span>
</span><span id="__span-10-209"><a id="__codelineno-10-209" name="__codelineno-10-209"></a>    <span class="p">},</span>
</span><span id="__span-10-210"><a id="__codelineno-10-210" name="__codelineno-10-210"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">"Sup_Validator"</span><span class="p">,</span>
</span><span id="__span-10-211"><a id="__codelineno-10-211" name="__codelineno-10-211"></a><span class="p">)</span>
</span><span id="__span-10-212"><a id="__codelineno-10-212" name="__codelineno-10-212"></a><span class="n">validator</span> <span class="o">=</span> <span class="p">{</span><span class="n">sup_validator</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_validator</span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>评价指标 <code>metric</code>，使用自定义函数，通过使用分子向量值进行分子生成，对重新生成分子进行单独的评估，在这里使用了自定义的评价指标分别是 <code>valid</code>、<code>unique</code>、<code>abs_unique</code></p>
<h3 id="36">3.6 模型训练与评估<a class="headerlink" href="#36" title="Permanent link">¶</a></h3>
<p>完成上述设置之后，只需要将上述实例化的对象按顺序传递给 ppsci.solver.Solver，然后启动训练、评估</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/moflow_train.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-214">214</a></span>
<span class="normal"><a href="#__codelineno-11-215">215</a></span>
<span class="normal"><a href="#__codelineno-11-216">216</a></span>
<span class="normal"><a href="#__codelineno-11-217">217</a></span>
<span class="normal"><a href="#__codelineno-11-218">218</a></span>
<span class="normal"><a href="#__codelineno-11-219">219</a></span>
<span class="normal"><a href="#__codelineno-11-220">220</a></span>
<span class="normal"><a href="#__codelineno-11-221">221</a></span>
<span class="normal"><a href="#__codelineno-11-222">222</a></span>
<span class="normal"><a href="#__codelineno-11-223">223</a></span>
<span class="normal"><a href="#__codelineno-11-224">224</a></span>
<span class="normal"><a href="#__codelineno-11-225">225</a></span>
<span class="normal"><a href="#__codelineno-11-226">226</a></span>
<span class="normal"><a href="#__codelineno-11-227">227</a></span>
<span class="normal"><a href="#__codelineno-11-228">228</a></span>
<span class="normal"><a href="#__codelineno-11-229">229</a></span>
<span class="normal"><a href="#__codelineno-11-230">230</a></span>
<span class="normal"><a href="#__codelineno-11-231">231</a></span>
<span class="normal"><a href="#__codelineno-11-232">232</a></span>
<span class="normal"><a href="#__codelineno-11-233">233</a></span>
<span class="normal"><a href="#__codelineno-11-234">234</a></span>
<span class="normal"><a href="#__codelineno-11-235">235</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-214"><a id="__codelineno-11-214" name="__codelineno-11-214"></a><span class="c1"># initialize solver</span>
</span><span id="__span-11-215"><a id="__codelineno-11-215" name="__codelineno-11-215"></a><span class="n">solver</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span>
</span><span id="__span-11-216"><a id="__codelineno-11-216" name="__codelineno-11-216"></a>    <span class="n">model</span><span class="p">,</span>
</span><span id="__span-11-217"><a id="__codelineno-11-217" name="__codelineno-11-217"></a>    <span class="n">constraint</span><span class="p">,</span>
</span><span id="__span-11-218"><a id="__codelineno-11-218" name="__codelineno-11-218"></a>    <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
</span><span id="__span-11-219"><a id="__codelineno-11-219" name="__codelineno-11-219"></a>    <span class="n">optimizer</span><span class="p">,</span>
</span><span id="__span-11-220"><a id="__codelineno-11-220" name="__codelineno-11-220"></a>    <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-11-221"><a id="__codelineno-11-221" name="__codelineno-11-221"></a>    <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="__span-11-222"><a id="__codelineno-11-222" name="__codelineno-11-222"></a>    <span class="n">ITERS_PER_EPOCH</span><span class="p">,</span>
</span><span id="__span-11-223"><a id="__codelineno-11-223" name="__codelineno-11-223"></a>    <span class="n">seed</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="__span-11-224"><a id="__codelineno-11-224" name="__codelineno-11-224"></a>    <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
</span><span id="__span-11-225"><a id="__codelineno-11-225" name="__codelineno-11-225"></a>    <span class="n">save_freq</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">save_freq</span><span class="p">,</span>
</span><span id="__span-11-226"><a id="__codelineno-11-226" name="__codelineno-11-226"></a>    <span class="n">eval_during_train</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">eval_during_train</span><span class="p">,</span>
</span><span id="__span-11-227"><a id="__codelineno-11-227" name="__codelineno-11-227"></a>    <span class="n">eval_freq</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">eval_freq</span><span class="p">,</span>
</span><span id="__span-11-228"><a id="__codelineno-11-228" name="__codelineno-11-228"></a>    <span class="n">compute_metric_by_batch</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">compute_metric_by_batch</span><span class="p">,</span>
</span><span id="__span-11-229"><a id="__codelineno-11-229" name="__codelineno-11-229"></a>    <span class="n">eval_with_no_grad</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">eval_with_no_grad</span><span class="p">,</span>
</span><span id="__span-11-230"><a id="__codelineno-11-230" name="__codelineno-11-230"></a><span class="p">)</span>
</span><span id="__span-11-231"><a id="__codelineno-11-231" name="__codelineno-11-231"></a><span class="c1"># train model</span>
</span><span id="__span-11-232"><a id="__codelineno-11-232" name="__codelineno-11-232"></a><span class="n">solver</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-11-233"><a id="__codelineno-11-233" name="__codelineno-11-233"></a>
</span><span id="__span-11-234"><a id="__codelineno-11-234" name="__codelineno-11-234"></a><span class="c1"># validation for training</span>
</span><span id="__span-11-235"><a id="__codelineno-11-235" name="__codelineno-11-235"></a><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="37">3.7 模型的生成评估构建<a class="headerlink" href="#37" title="Permanent link">¶</a></h3>
<p>针对不同数据集构建，提供了不同模型的不同方式评估，通过重建，随机生成，插值生成的方式对于模型生成能力进行全面评估，不同方式参数配置不同，参数配置文件如下所示：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/conf/moflow_test.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-12-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-12-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-12-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-12-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-12-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-12-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-12-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-12-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-12-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-12-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-12-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-12-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-12-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-12-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-12-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-12-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-12-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-12-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-12-100">100</a></span>
<span class="normal"><a href="#__codelineno-12-101">101</a></span>
<span class="normal"><a href="#__codelineno-12-102">102</a></span>
<span class="normal"><a href="#__codelineno-12-103">103</a></span>
<span class="normal"><a href="#__codelineno-12-104">104</a></span>
<span class="normal"><a href="#__codelineno-12-105">105</a></span>
<span class="normal"><a href="#__codelineno-12-106">106</a></span>
<span class="normal"><a href="#__codelineno-12-107">107</a></span>
<span class="normal"><a href="#__codelineno-12-108">108</a></span>
<span class="normal"><a href="#__codelineno-12-109">109</a></span>
<span class="normal"><a href="#__codelineno-12-110">110</a></span>
<span class="normal"><a href="#__codelineno-12-111">111</a></span>
<span class="normal"><a href="#__codelineno-12-112">112</a></span>
<span class="normal"><a href="#__codelineno-12-113">113</a></span>
<span class="normal"><a href="#__codelineno-12-114">114</a></span>
<span class="normal"><a href="#__codelineno-12-115">115</a></span>
<span class="normal"><a href="#__codelineno-12-116">116</a></span>
<span class="normal"><a href="#__codelineno-12-117">117</a></span>
<span class="normal"><a href="#__codelineno-12-118">118</a></span>
<span class="normal"><a href="#__codelineno-12-119">119</a></span>
<span class="normal"><a href="#__codelineno-12-120">120</a></span>
<span class="normal"><a href="#__codelineno-12-121">121</a></span>
<span class="normal"><a href="#__codelineno-12-122">122</a></span>
<span class="normal"><a href="#__codelineno-12-123">123</a></span>
<span class="normal"><a href="#__codelineno-12-124">124</a></span>
<span class="normal"><a href="#__codelineno-12-125">125</a></span>
<span class="normal"><a href="#__codelineno-12-126">126</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-81"><a id="__codelineno-12-81" name="__codelineno-12-81"></a><span class="c1"># evaluation settings</span>
</span><span id="__span-12-82"><a id="__codelineno-12-82" name="__codelineno-12-82"></a><span class="n">EVAL</span><span class="p">:</span>
</span><span id="__span-12-83"><a id="__codelineno-12-83" name="__codelineno-12-83"></a>  <span class="n">pretrained_model_path</span><span class="p">:</span> <span class="n">null</span>
</span><span id="__span-12-84"><a id="__codelineno-12-84" name="__codelineno-12-84"></a>  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">256</span>
</span><span id="__span-12-85"><a id="__codelineno-12-85" name="__codelineno-12-85"></a>  <span class="n">num_workers</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="__span-12-86"><a id="__codelineno-12-86" name="__codelineno-12-86"></a>  <span class="n">reconstruct</span><span class="p">:</span> <span class="n">false</span>
</span><span id="__span-12-87"><a id="__codelineno-12-87" name="__codelineno-12-87"></a>  <span class="n">int2point</span><span class="p">:</span> <span class="n">false</span>
</span><span id="__span-12-88"><a id="__codelineno-12-88" name="__codelineno-12-88"></a>  <span class="n">intgrid</span><span class="p">:</span> <span class="n">false</span>
</span><span id="__span-12-89"><a id="__codelineno-12-89" name="__codelineno-12-89"></a>  <span class="n">inter_times</span><span class="p">:</span> <span class="mi">5</span>
</span><span id="__span-12-90"><a id="__codelineno-12-90" name="__codelineno-12-90"></a>  <span class="n">correct_validity</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-12-91"><a id="__codelineno-12-91" name="__codelineno-12-91"></a>  <span class="n">temperature</span><span class="p">:</span> <span class="mf">1.0</span>
</span><span id="__span-12-92"><a id="__codelineno-12-92" name="__codelineno-12-92"></a>  <span class="n">delta</span><span class="p">:</span> <span class="mf">0.1</span>
</span><span id="__span-12-93"><a id="__codelineno-12-93" name="__codelineno-12-93"></a>  <span class="n">n_experiments</span><span class="p">:</span>
</span><span id="__span-12-94"><a id="__codelineno-12-94" name="__codelineno-12-94"></a>  <span class="n">save_fig</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-12-95"><a id="__codelineno-12-95" name="__codelineno-12-95"></a>
</span><span id="__span-12-96"><a id="__codelineno-12-96" name="__codelineno-12-96"></a><span class="n">EVAL_mode</span><span class="p">:</span> <span class="n">Intergrid</span> <span class="c1">#select EVAL_mode: Reconstruct/Random/Inter2point/Intergrid</span>
</span><span id="__span-12-97"><a id="__codelineno-12-97" name="__codelineno-12-97"></a>
</span><span id="__span-12-98"><a id="__codelineno-12-98" name="__codelineno-12-98"></a><span class="n">Reconstruct</span><span class="p">:</span> <span class="c1">#重建生成，针对不同数据集的分子进行重建生成</span>
</span><span id="__span-12-99"><a id="__codelineno-12-99" name="__codelineno-12-99"></a>  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">256</span>
</span><span id="__span-12-100"><a id="__codelineno-12-100" name="__codelineno-12-100"></a>  <span class="n">reconstruct</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-12-101"><a id="__codelineno-12-101" name="__codelineno-12-101"></a>  <span class="n">n_experiments</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="__span-12-102"><a id="__codelineno-12-102" name="__codelineno-12-102"></a>
</span><span id="__span-12-103"><a id="__codelineno-12-103" name="__codelineno-12-103"></a><span class="n">Random</span><span class="p">:</span> <span class="c1">#随机生成，针对不同的数据集从潜在空间进行随机生成，10000个样本生成5次</span>
</span><span id="__span-12-104"><a id="__codelineno-12-104" name="__codelineno-12-104"></a>  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">10000</span>
</span><span id="__span-12-105"><a id="__codelineno-12-105" name="__codelineno-12-105"></a>  <span class="n">temperature</span><span class="p">:</span> <span class="mf">0.85</span>
</span><span id="__span-12-106"><a id="__codelineno-12-106" name="__codelineno-12-106"></a>  <span class="n">delta</span><span class="p">:</span> <span class="mf">0.05</span>
</span><span id="__span-12-107"><a id="__codelineno-12-107" name="__codelineno-12-107"></a>  <span class="n">n_experiments</span><span class="p">:</span> <span class="mi">5</span>
</span><span id="__span-12-108"><a id="__codelineno-12-108" name="__codelineno-12-108"></a>  <span class="n">save_fig</span><span class="p">:</span> <span class="n">false</span>
</span><span id="__span-12-109"><a id="__codelineno-12-109" name="__codelineno-12-109"></a>  <span class="n">correct_validity</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-12-110"><a id="__codelineno-12-110" name="__codelineno-12-110"></a>
</span><span id="__span-12-111"><a id="__codelineno-12-111" name="__codelineno-12-111"></a><span class="n">Inter2point</span><span class="p">:</span> <span class="c1">#在潜在空间进行插值，两个分子之间插值可视化生成分子图</span>
</span><span id="__span-12-112"><a id="__codelineno-12-112" name="__codelineno-12-112"></a>  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">1000</span>
</span><span id="__span-12-113"><a id="__codelineno-12-113" name="__codelineno-12-113"></a>  <span class="n">int2point</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-12-114"><a id="__codelineno-12-114" name="__codelineno-12-114"></a>  <span class="n">temperature</span><span class="p">:</span> <span class="mf">0.65</span>
</span><span id="__span-12-115"><a id="__codelineno-12-115" name="__codelineno-12-115"></a>  <span class="n">inter_times</span><span class="p">:</span> <span class="mi">50</span>
</span><span id="__span-12-116"><a id="__codelineno-12-116" name="__codelineno-12-116"></a>  <span class="n">correct_validity</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-12-117"><a id="__codelineno-12-117" name="__codelineno-12-117"></a>  <span class="n">n_experiments</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="__span-12-118"><a id="__codelineno-12-118" name="__codelineno-12-118"></a>
</span><span id="__span-12-119"><a id="__codelineno-12-119" name="__codelineno-12-119"></a><span class="n">Intergrid</span><span class="p">:</span> <span class="c1">#在潜在空间进行插值，分子网格进行可视化生成分子图</span>
</span><span id="__span-12-120"><a id="__codelineno-12-120" name="__codelineno-12-120"></a>  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">1000</span>
</span><span id="__span-12-121"><a id="__codelineno-12-121" name="__codelineno-12-121"></a>  <span class="n">temperature</span><span class="p">:</span> <span class="mf">0.65</span>
</span><span id="__span-12-122"><a id="__codelineno-12-122" name="__codelineno-12-122"></a>  <span class="n">delta</span><span class="p">:</span> <span class="mi">5</span>
</span><span id="__span-12-123"><a id="__codelineno-12-123" name="__codelineno-12-123"></a>  <span class="n">intgrid</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-12-124"><a id="__codelineno-12-124" name="__codelineno-12-124"></a>  <span class="n">inter_times</span><span class="p">:</span> <span class="mi">40</span>
</span><span id="__span-12-125"><a id="__codelineno-12-125" name="__codelineno-12-125"></a>  <span class="n">correct_validity</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-12-126"><a id="__codelineno-12-126" name="__codelineno-12-126"></a>  <span class="n">n_experiments</span><span class="p">:</span> <span class="mi">0</span>
</span></code></pre></div></td></tr></table></div>
<p>其中，EVAL_mode为选择的评估模式，不同的模式评估的方式不同，Reconstruct（重建生成）针对不同的数据集进行药物分子的重建生成，在选定的数据集中的分子进行重建生成；Random（随机生成）针对不同的数据集从潜在空间进行随机生成，参数设置是从10000个样本中随机生成5次；Inter2point（分子间插值生成）在潜在空间进行插值，两个分子之间插值可视化生成分子图；Intergrid（分子网格插值生成）在潜在空间进行插值，分子网格进行可视化生成分子图（插值生成将生成的新分子可视化存储图片）。每种模式下参数根据实际情况进行调整，其中包括结果存储，生成的分子的数量等，其余配置与训练一样，在选择不同数据集训练的模型注意修改数据名称，核对预训练模型的位置。</p>
<p>构建评估器的代码为：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/test_generate.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-368">368</a></span>
<span class="normal"><a href="#__codelineno-13-369">369</a></span>
<span class="normal"><a href="#__codelineno-13-370">370</a></span>
<span class="normal"><a href="#__codelineno-13-371">371</a></span>
<span class="normal"><a href="#__codelineno-13-372">372</a></span>
<span class="normal"><a href="#__codelineno-13-373">373</a></span>
<span class="normal"><a href="#__codelineno-13-374">374</a></span>
<span class="normal"><a href="#__codelineno-13-375">375</a></span>
<span class="normal"><a href="#__codelineno-13-376">376</a></span>
<span class="normal"><a href="#__codelineno-13-377">377</a></span>
<span class="normal"><a href="#__codelineno-13-378">378</a></span>
<span class="normal"><a href="#__codelineno-13-379">379</a></span>
<span class="normal"><a href="#__codelineno-13-380">380</a></span>
<span class="normal"><a href="#__codelineno-13-381">381</a></span>
<span class="normal"><a href="#__codelineno-13-382">382</a></span>
<span class="normal"><a href="#__codelineno-13-383">383</a></span>
<span class="normal"><a href="#__codelineno-13-384">384</a></span>
<span class="normal"><a href="#__codelineno-13-385">385</a></span>
<span class="normal"><a href="#__codelineno-13-386">386</a></span>
<span class="normal"><a href="#__codelineno-13-387">387</a></span>
<span class="normal"><a href="#__codelineno-13-388">388</a></span>
<span class="normal"><a href="#__codelineno-13-389">389</a></span>
<span class="normal"><a href="#__codelineno-13-390">390</a></span>
<span class="normal"><a href="#__codelineno-13-391">391</a></span>
<span class="normal"><a href="#__codelineno-13-392">392</a></span>
<span class="normal"><a href="#__codelineno-13-393">393</a></span>
<span class="normal"><a href="#__codelineno-13-394">394</a></span>
<span class="normal"><a href="#__codelineno-13-395">395</a></span>
<span class="normal"><a href="#__codelineno-13-396">396</a></span>
<span class="normal"><a href="#__codelineno-13-397">397</a></span>
<span class="normal"><a href="#__codelineno-13-398">398</a></span>
<span class="normal"><a href="#__codelineno-13-399">399</a></span>
<span class="normal"><a href="#__codelineno-13-400">400</a></span>
<span class="normal"><a href="#__codelineno-13-401">401</a></span>
<span class="normal"><a href="#__codelineno-13-402">402</a></span>
<span class="normal"><a href="#__codelineno-13-403">403</a></span>
<span class="normal"><a href="#__codelineno-13-404">404</a></span>
<span class="normal"><a href="#__codelineno-13-405">405</a></span>
<span class="normal"><a href="#__codelineno-13-406">406</a></span>
<span class="normal"><a href="#__codelineno-13-407">407</a></span>
<span class="normal"><a href="#__codelineno-13-408">408</a></span>
<span class="normal"><a href="#__codelineno-13-409">409</a></span>
<span class="normal"><a href="#__codelineno-13-410">410</a></span>
<span class="normal"><a href="#__codelineno-13-411">411</a></span>
<span class="normal"><a href="#__codelineno-13-412">412</a></span>
<span class="normal"><a href="#__codelineno-13-413">413</a></span>
<span class="normal"><a href="#__codelineno-13-414">414</a></span>
<span class="normal"><a href="#__codelineno-13-415">415</a></span>
<span class="normal"><a href="#__codelineno-13-416">416</a></span>
<span class="normal"><a href="#__codelineno-13-417">417</a></span>
<span class="normal"><a href="#__codelineno-13-418">418</a></span>
<span class="normal"><a href="#__codelineno-13-419">419</a></span>
<span class="normal"><a href="#__codelineno-13-420">420</a></span>
<span class="normal"><a href="#__codelineno-13-421">421</a></span>
<span class="normal"><a href="#__codelineno-13-422">422</a></span>
<span class="normal"><a href="#__codelineno-13-423">423</a></span>
<span class="normal"><a href="#__codelineno-13-424">424</a></span>
<span class="normal"><a href="#__codelineno-13-425">425</a></span>
<span class="normal"><a href="#__codelineno-13-426">426</a></span>
<span class="normal"><a href="#__codelineno-13-427">427</a></span>
<span class="normal"><a href="#__codelineno-13-428">428</a></span>
<span class="normal"><a href="#__codelineno-13-429">429</a></span>
<span class="normal"><a href="#__codelineno-13-430">430</a></span>
<span class="normal"><a href="#__codelineno-13-431">431</a></span>
<span class="normal"><a href="#__codelineno-13-432">432</a></span>
<span class="normal"><a href="#__codelineno-13-433">433</a></span>
<span class="normal"><a href="#__codelineno-13-434">434</a></span>
<span class="normal"><a href="#__codelineno-13-435">435</a></span>
<span class="normal"><a href="#__codelineno-13-436">436</a></span>
<span class="normal"><a href="#__codelineno-13-437">437</a></span>
<span class="normal"><a href="#__codelineno-13-438">438</a></span>
<span class="normal"><a href="#__codelineno-13-439">439</a></span>
<span class="normal"><a href="#__codelineno-13-440">440</a></span>
<span class="normal"><a href="#__codelineno-13-441">441</a></span>
<span class="normal"><a href="#__codelineno-13-442">442</a></span>
<span class="normal"><a href="#__codelineno-13-443">443</a></span>
<span class="normal"><a href="#__codelineno-13-444">444</a></span>
<span class="normal"><a href="#__codelineno-13-445">445</a></span>
<span class="normal"><a href="#__codelineno-13-446">446</a></span>
<span class="normal"><a href="#__codelineno-13-447">447</a></span>
<span class="normal"><a href="#__codelineno-13-448">448</a></span>
<span class="normal"><a href="#__codelineno-13-449">449</a></span>
<span class="normal"><a href="#__codelineno-13-450">450</a></span>
<span class="normal"><a href="#__codelineno-13-451">451</a></span>
<span class="normal"><a href="#__codelineno-13-452">452</a></span>
<span class="normal"><a href="#__codelineno-13-453">453</a></span>
<span class="normal"><a href="#__codelineno-13-454">454</a></span>
<span class="normal"><a href="#__codelineno-13-455">455</a></span>
<span class="normal"><a href="#__codelineno-13-456">456</a></span>
<span class="normal"><a href="#__codelineno-13-457">457</a></span>
<span class="normal"><a href="#__codelineno-13-458">458</a></span>
<span class="normal"><a href="#__codelineno-13-459">459</a></span>
<span class="normal"><a href="#__codelineno-13-460">460</a></span>
<span class="normal"><a href="#__codelineno-13-461">461</a></span>
<span class="normal"><a href="#__codelineno-13-462">462</a></span>
<span class="normal"><a href="#__codelineno-13-463">463</a></span>
<span class="normal"><a href="#__codelineno-13-464">464</a></span>
<span class="normal"><a href="#__codelineno-13-465">465</a></span>
<span class="normal"><a href="#__codelineno-13-466">466</a></span>
<span class="normal"><a href="#__codelineno-13-467">467</a></span>
<span class="normal"><a href="#__codelineno-13-468">468</a></span>
<span class="normal"><a href="#__codelineno-13-469">469</a></span>
<span class="normal"><a href="#__codelineno-13-470">470</a></span>
<span class="normal"><a href="#__codelineno-13-471">471</a></span>
<span class="normal"><a href="#__codelineno-13-472">472</a></span>
<span class="normal"><a href="#__codelineno-13-473">473</a></span>
<span class="normal"><a href="#__codelineno-13-474">474</a></span>
<span class="normal"><a href="#__codelineno-13-475">475</a></span>
<span class="normal"><a href="#__codelineno-13-476">476</a></span>
<span class="normal"><a href="#__codelineno-13-477">477</a></span>
<span class="normal"><a href="#__codelineno-13-478">478</a></span>
<span class="normal"><a href="#__codelineno-13-479">479</a></span>
<span class="normal"><a href="#__codelineno-13-480">480</a></span>
<span class="normal"><a href="#__codelineno-13-481">481</a></span>
<span class="normal"><a href="#__codelineno-13-482">482</a></span>
<span class="normal"><a href="#__codelineno-13-483">483</a></span>
<span class="normal"><a href="#__codelineno-13-484">484</a></span>
<span class="normal"><a href="#__codelineno-13-485">485</a></span>
<span class="normal"><a href="#__codelineno-13-486">486</a></span>
<span class="normal"><a href="#__codelineno-13-487">487</a></span>
<span class="normal"><a href="#__codelineno-13-488">488</a></span>
<span class="normal"><a href="#__codelineno-13-489">489</a></span>
<span class="normal"><a href="#__codelineno-13-490">490</a></span>
<span class="normal"><a href="#__codelineno-13-491">491</a></span>
<span class="normal"><a href="#__codelineno-13-492">492</a></span>
<span class="normal"><a href="#__codelineno-13-493">493</a></span>
<span class="normal"><a href="#__codelineno-13-494">494</a></span>
<span class="normal"><a href="#__codelineno-13-495">495</a></span>
<span class="normal"><a href="#__codelineno-13-496">496</a></span>
<span class="normal"><a href="#__codelineno-13-497">497</a></span>
<span class="normal"><a href="#__codelineno-13-498">498</a></span>
<span class="normal"><a href="#__codelineno-13-499">499</a></span>
<span class="normal"><a href="#__codelineno-13-500">500</a></span>
<span class="normal"><a href="#__codelineno-13-501">501</a></span>
<span class="normal"><a href="#__codelineno-13-502">502</a></span>
<span class="normal"><a href="#__codelineno-13-503">503</a></span>
<span class="normal"><a href="#__codelineno-13-504">504</a></span>
<span class="normal"><a href="#__codelineno-13-505">505</a></span>
<span class="normal"><a href="#__codelineno-13-506">506</a></span>
<span class="normal"><a href="#__codelineno-13-507">507</a></span>
<span class="normal"><a href="#__codelineno-13-508">508</a></span>
<span class="normal"><a href="#__codelineno-13-509">509</a></span>
<span class="normal"><a href="#__codelineno-13-510">510</a></span>
<span class="normal"><a href="#__codelineno-13-511">511</a></span>
<span class="normal"><a href="#__codelineno-13-512">512</a></span>
<span class="normal"><a href="#__codelineno-13-513">513</a></span>
<span class="normal"><a href="#__codelineno-13-514">514</a></span>
<span class="normal"><a href="#__codelineno-13-515">515</a></span>
<span class="normal"><a href="#__codelineno-13-516">516</a></span>
<span class="normal"><a href="#__codelineno-13-517">517</a></span>
<span class="normal"><a href="#__codelineno-13-518">518</a></span>
<span class="normal"><a href="#__codelineno-13-519">519</a></span>
<span class="normal"><a href="#__codelineno-13-520">520</a></span>
<span class="normal"><a href="#__codelineno-13-521">521</a></span>
<span class="normal"><a href="#__codelineno-13-522">522</a></span>
<span class="normal"><a href="#__codelineno-13-523">523</a></span>
<span class="normal"><a href="#__codelineno-13-524">524</a></span>
<span class="normal"><a href="#__codelineno-13-525">525</a></span>
<span class="normal"><a href="#__codelineno-13-526">526</a></span>
<span class="normal"><a href="#__codelineno-13-527">527</a></span>
<span class="normal"><a href="#__codelineno-13-528">528</a></span>
<span class="normal"><a href="#__codelineno-13-529">529</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-368"><a id="__codelineno-13-368" name="__codelineno-13-368"></a><span class="n">dataloader_cfg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-13-369"><a id="__codelineno-13-369" name="__codelineno-13-369"></a>    <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-370"><a id="__codelineno-13-370" name="__codelineno-13-370"></a>        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"MOlFLOWDataset"</span><span class="p">,</span>
</span><span id="__span-13-371"><a id="__codelineno-13-371" name="__codelineno-13-371"></a>        <span class="s2">"file_path"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span>
</span><span id="__span-13-372"><a id="__codelineno-13-372" name="__codelineno-13-372"></a>        <span class="s2">"data_name"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-13-373"><a id="__codelineno-13-373" name="__codelineno-13-373"></a>        <span class="s2">"mode"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
</span><span id="__span-13-374"><a id="__codelineno-13-374" name="__codelineno-13-374"></a>        <span class="s2">"valid_idx"</span><span class="p">:</span> <span class="n">valid_idx</span><span class="p">,</span>
</span><span id="__span-13-375"><a id="__codelineno-13-375" name="__codelineno-13-375"></a>        <span class="s2">"input_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">input_keys</span><span class="p">,</span>
</span><span id="__span-13-376"><a id="__codelineno-13-376" name="__codelineno-13-376"></a>        <span class="s2">"label_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">label_keys</span><span class="p">,</span>
</span><span id="__span-13-377"><a id="__codelineno-13-377" name="__codelineno-13-377"></a>        <span class="s2">"smiles_col"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
</span><span id="__span-13-378"><a id="__codelineno-13-378" name="__codelineno-13-378"></a>        <span class="s2">"transform_fn"</span><span class="p">:</span> <span class="n">transform_fn</span><span class="p">,</span>
</span><span id="__span-13-379"><a id="__codelineno-13-379" name="__codelineno-13-379"></a>    <span class="p">},</span>
</span><span id="__span-13-380"><a id="__codelineno-13-380" name="__codelineno-13-380"></a>    <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-13-381"><a id="__codelineno-13-381" name="__codelineno-13-381"></a>        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-13-382"><a id="__codelineno-13-382" name="__codelineno-13-382"></a>        <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-13-383"><a id="__codelineno-13-383" name="__codelineno-13-383"></a>        <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-13-384"><a id="__codelineno-13-384" name="__codelineno-13-384"></a>    <span class="p">},</span>
</span><span id="__span-13-385"><a id="__codelineno-13-385" name="__codelineno-13-385"></a>    <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-13-386"><a id="__codelineno-13-386" name="__codelineno-13-386"></a>    <span class="s2">"num_workers"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
</span><span id="__span-13-387"><a id="__codelineno-13-387" name="__codelineno-13-387"></a><span class="p">}</span>
</span><span id="__span-13-388"><a id="__codelineno-13-388" name="__codelineno-13-388"></a>
</span><span id="__span-13-389"><a id="__codelineno-13-389" name="__codelineno-13-389"></a><span class="n">test</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">build_dataset</span><span class="p">(</span><span class="n">dataloader_cfg</span><span class="p">[</span><span class="s2">"dataset"</span><span class="p">])</span>
</span><span id="__span-13-390"><a id="__codelineno-13-390" name="__codelineno-13-390"></a><span class="n">dataloader_cfg</span><span class="p">[</span><span class="s2">"dataset"</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"mode"</span><span class="p">:</span> <span class="s2">"train"</span><span class="p">})</span>
</span><span id="__span-13-391"><a id="__codelineno-13-391" name="__codelineno-13-391"></a><span class="n">train</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">build_dataset</span><span class="p">(</span><span class="n">dataloader_cfg</span><span class="p">[</span><span class="s2">"dataset"</span><span class="p">])</span>
</span><span id="__span-13-392"><a id="__codelineno-13-392" name="__codelineno-13-392"></a><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-13-393"><a id="__codelineno-13-393" name="__codelineno-13-393"></a>    <span class="s2">"</span><span class="si">{}</span><span class="s2"> in total, </span><span class="si">{}</span><span class="s2">  training data, </span><span class="si">{}</span><span class="s2">  testing data, </span><span class="si">{}</span><span class="s2"> batchsize, train/batchsize </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-13-394"><a id="__codelineno-13-394" name="__codelineno-13-394"></a>        <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">),</span>
</span><span id="__span-13-395"><a id="__codelineno-13-395" name="__codelineno-13-395"></a>        <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">),</span>
</span><span id="__span-13-396"><a id="__codelineno-13-396" name="__codelineno-13-396"></a>        <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">),</span>
</span><span id="__span-13-397"><a id="__codelineno-13-397" name="__codelineno-13-397"></a>        <span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-13-398"><a id="__codelineno-13-398" name="__codelineno-13-398"></a>        <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-13-399"><a id="__codelineno-13-399" name="__codelineno-13-399"></a>    <span class="p">)</span>
</span><span id="__span-13-400"><a id="__codelineno-13-400" name="__codelineno-13-400"></a><span class="p">)</span>
</span><span id="__span-13-401"><a id="__codelineno-13-401" name="__codelineno-13-401"></a>
</span><span id="__span-13-402"><a id="__codelineno-13-402" name="__codelineno-13-402"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">reconstruct</span><span class="p">:</span>
</span><span id="__span-13-403"><a id="__codelineno-13-403" name="__codelineno-13-403"></a>    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">dataloader_cfg</span><span class="p">)</span>
</span><span id="__span-13-404"><a id="__codelineno-13-404" name="__codelineno-13-404"></a>    <span class="n">reconstruction_rate_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-405"><a id="__codelineno-13-405" name="__codelineno-13-405"></a>    <span class="n">max_iter</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span>
</span><span id="__span-13-406"><a id="__codelineno-13-406" name="__codelineno-13-406"></a>    <span class="n">input_keys</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">input_keys</span>
</span><span id="__span-13-407"><a id="__codelineno-13-407" name="__codelineno-13-407"></a>    <span class="n">output_keys</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">output_keys</span>
</span><span id="__span-13-408"><a id="__codelineno-13-408" name="__codelineno-13-408"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="__span-13-409"><a id="__codelineno-13-409" name="__codelineno-13-409"></a>        <span class="n">output_dict</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="__span-13-410"><a id="__codelineno-13-410" name="__codelineno-13-410"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">input_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="__span-13-411"><a id="__codelineno-13-411" name="__codelineno-13-411"></a>        <span class="n">adj</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">input_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="__span-13-412"><a id="__codelineno-13-412" name="__codelineno-13-412"></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">output_dict</span><span class="p">[</span><span class="n">output_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="__span-13-413"><a id="__codelineno-13-413" name="__codelineno-13-413"></a>        <span class="n">z0</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="__span-13-414"><a id="__codelineno-13-414" name="__codelineno-13-414"></a>        <span class="n">z1</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="__span-13-415"><a id="__codelineno-13-415" name="__codelineno-13-415"></a>        <span class="n">adj_rev</span><span class="p">,</span> <span class="n">x_rev</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">paddle</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="__span-13-416"><a id="__codelineno-13-416" name="__codelineno-13-416"></a>        <span class="n">reverse_smiles</span> <span class="o">=</span> <span class="n">adj_to_smiles</span><span class="p">(</span><span class="n">adj_rev</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">x_rev</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-13-417"><a id="__codelineno-13-417" name="__codelineno-13-417"></a>        <span class="n">train_smiles</span> <span class="o">=</span> <span class="n">adj_to_smiles</span><span class="p">(</span><span class="n">adj</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-13-418"><a id="__codelineno-13-418" name="__codelineno-13-418"></a>        <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_smiles</span><span class="p">,</span> <span class="n">reverse_smiles</span><span class="p">)])</span>
</span><span id="__span-13-419"><a id="__codelineno-13-419" name="__codelineno-13-419"></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-13-420"><a id="__codelineno-13-420" name="__codelineno-13-420"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-13-421"><a id="__codelineno-13-421" name="__codelineno-13-421"></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
</span><span id="__span-13-422"><a id="__codelineno-13-422" name="__codelineno-13-422"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-13-423"><a id="__codelineno-13-423" name="__codelineno-13-423"></a>                    <span class="s2">"</span><span class="si">{}</span><span class="s2">, train: </span><span class="si">{}</span><span class="s2">, reverse: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-13-424"><a id="__codelineno-13-424" name="__codelineno-13-424"></a>                        <span class="n">i</span> <span class="o">*</span> <span class="n">batch_size</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">train_smiles</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">reverse_smiles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="__span-13-425"><a id="__codelineno-13-425" name="__codelineno-13-425"></a>                    <span class="p">)</span>
</span><span id="__span-13-426"><a id="__codelineno-13-426" name="__codelineno-13-426"></a>                <span class="p">)</span>
</span><span id="__span-13-427"><a id="__codelineno-13-427" name="__codelineno-13-427"></a>        <span class="n">reconstruction_rate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">lb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="__span-13-428"><a id="__codelineno-13-428" name="__codelineno-13-428"></a>        <span class="n">reconstruction_rate_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reconstruction_rate</span><span class="p">)</span>
</span><span id="__span-13-429"><a id="__codelineno-13-429" name="__codelineno-13-429"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
</span><span id="__span-13-430"><a id="__codelineno-13-430" name="__codelineno-13-430"></a>            <span class="s2">"iter/total: </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">, reconstruction_rate:</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-13-431"><a id="__codelineno-13-431" name="__codelineno-13-431"></a>                <span class="n">i</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">reconstruction_rate</span>
</span><span id="__span-13-432"><a id="__codelineno-13-432" name="__codelineno-13-432"></a>            <span class="p">)</span>
</span><span id="__span-13-433"><a id="__codelineno-13-433" name="__codelineno-13-433"></a>        <span class="p">)</span>
</span><span id="__span-13-434"><a id="__codelineno-13-434" name="__codelineno-13-434"></a>    <span class="n">reconstruction_rate_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reconstruction_rate_list</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="__span-13-435"><a id="__codelineno-13-435" name="__codelineno-13-435"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
</span><span id="__span-13-436"><a id="__codelineno-13-436" name="__codelineno-13-436"></a>        <span class="s2">"reconstruction_rate for all the train data:</span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-13-437"><a id="__codelineno-13-437" name="__codelineno-13-437"></a>            <span class="n">reconstruction_rate_total</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
</span><span id="__span-13-438"><a id="__codelineno-13-438" name="__codelineno-13-438"></a>        <span class="p">)</span>
</span><span id="__span-13-439"><a id="__codelineno-13-439" name="__codelineno-13-439"></a>    <span class="p">)</span>
</span><span id="__span-13-440"><a id="__codelineno-13-440" name="__codelineno-13-440"></a>    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-441"><a id="__codelineno-13-441" name="__codelineno-13-441"></a>
</span><span id="__span-13-442"><a id="__codelineno-13-442" name="__codelineno-13-442"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">int2point</span><span class="p">:</span>
</span><span id="__span-13-443"><a id="__codelineno-13-443" name="__codelineno-13-443"></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">input</span>
</span><span id="__span-13-444"><a id="__codelineno-13-444" name="__codelineno-13-444"></a>    <span class="n">labels</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">label</span>
</span><span id="__span-13-445"><a id="__codelineno-13-445" name="__codelineno-13-445"></a>    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-446"><a id="__codelineno-13-446" name="__codelineno-13-446"></a>    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)):</span>
</span><span id="__span-13-447"><a id="__codelineno-13-447" name="__codelineno-13-447"></a>        <span class="n">input_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="__span-13-448"><a id="__codelineno-13-448" name="__codelineno-13-448"></a>        <span class="n">label_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="__span-13-449"><a id="__codelineno-13-449" name="__codelineno-13-449"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">input_item</span> <span class="o">+</span> <span class="n">label_item</span>
</span><span id="__span-13-450"><a id="__codelineno-13-450" name="__codelineno-13-450"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">transform_fn</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="__span-13-451"><a id="__codelineno-13-451" name="__codelineno-13-451"></a>        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="__span-13-452"><a id="__codelineno-13-452" name="__codelineno-13-452"></a>    <span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="__span-13-453"><a id="__codelineno-13-453" name="__codelineno-13-453"></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">)}</span>
</span><span id="__span-13-454"><a id="__codelineno-13-454" name="__codelineno-13-454"></a>
</span><span id="__span-13-455"><a id="__codelineno-13-455" name="__codelineno-13-455"></a>    <span class="n">mol_smiles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-456"><a id="__codelineno-13-456" name="__codelineno-13-456"></a>    <span class="n">gen_dir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL_mode</span><span class="p">)</span>
</span><span id="__span-13-457"><a id="__codelineno-13-457" name="__codelineno-13-457"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"Dump figure in </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gen_dir</span><span class="p">))</span>
</span><span id="__span-13-458"><a id="__codelineno-13-458" name="__codelineno-13-458"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gen_dir</span><span class="p">):</span>
</span><span id="__span-13-459"><a id="__codelineno-13-459" name="__codelineno-13-459"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">gen_dir</span><span class="p">)</span>
</span><span id="__span-13-460"><a id="__codelineno-13-460" name="__codelineno-13-460"></a>    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">inter_times</span><span class="p">):</span>
</span><span id="__span-13-461"><a id="__codelineno-13-461" name="__codelineno-13-461"></a>        <span class="n">filepath</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-13-462"><a id="__codelineno-13-462" name="__codelineno-13-462"></a>            <span class="n">gen_dir</span><span class="p">,</span> <span class="s2">"2points_interpolation-2point_molecules_seed</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-13-463"><a id="__codelineno-13-463" name="__codelineno-13-463"></a>        <span class="p">)</span>
</span><span id="__span-13-464"><a id="__codelineno-13-464" name="__codelineno-13-464"></a>        <span class="n">visualize_interpolation_between_2_points</span><span class="p">(</span>
</span><span id="__span-13-465"><a id="__codelineno-13-465" name="__codelineno-13-465"></a>            <span class="n">filepath</span><span class="p">,</span>
</span><span id="__span-13-466"><a id="__codelineno-13-466" name="__codelineno-13-466"></a>            <span class="n">model</span><span class="p">,</span>
</span><span id="__span-13-467"><a id="__codelineno-13-467" name="__codelineno-13-467"></a>            <span class="n">mol_smiles</span><span class="o">=</span><span class="n">mol_smiles</span><span class="p">,</span>
</span><span id="__span-13-468"><a id="__codelineno-13-468" name="__codelineno-13-468"></a>            <span class="n">mols_per_row</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
</span><span id="__span-13-469"><a id="__codelineno-13-469" name="__codelineno-13-469"></a>            <span class="n">n_interpolation</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
</span><span id="__span-13-470"><a id="__codelineno-13-470" name="__codelineno-13-470"></a>            <span class="n">atomic_num_list</span><span class="o">=</span><span class="n">atomic_num_list</span><span class="p">,</span>
</span><span id="__span-13-471"><a id="__codelineno-13-471" name="__codelineno-13-471"></a>            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="__span-13-472"><a id="__codelineno-13-472" name="__codelineno-13-472"></a>            <span class="n">true_data</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="__span-13-473"><a id="__codelineno-13-473" name="__codelineno-13-473"></a>            <span class="n">data_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-13-474"><a id="__codelineno-13-474" name="__codelineno-13-474"></a>        <span class="p">)</span>
</span><span id="__span-13-475"><a id="__codelineno-13-475" name="__codelineno-13-475"></a>    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-476"><a id="__codelineno-13-476" name="__codelineno-13-476"></a>
</span><span id="__span-13-477"><a id="__codelineno-13-477" name="__codelineno-13-477"></a><span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">intgrid</span><span class="p">:</span>
</span><span id="__span-13-478"><a id="__codelineno-13-478" name="__codelineno-13-478"></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">input</span>
</span><span id="__span-13-479"><a id="__codelineno-13-479" name="__codelineno-13-479"></a>    <span class="n">labels</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">label</span>
</span><span id="__span-13-480"><a id="__codelineno-13-480" name="__codelineno-13-480"></a>    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-481"><a id="__codelineno-13-481" name="__codelineno-13-481"></a>    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)):</span>
</span><span id="__span-13-482"><a id="__codelineno-13-482" name="__codelineno-13-482"></a>        <span class="n">input_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="__span-13-483"><a id="__codelineno-13-483" name="__codelineno-13-483"></a>        <span class="n">label_item</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="__span-13-484"><a id="__codelineno-13-484" name="__codelineno-13-484"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">input_item</span> <span class="o">+</span> <span class="n">label_item</span>
</span><span id="__span-13-485"><a id="__codelineno-13-485" name="__codelineno-13-485"></a>        <span class="n">item</span> <span class="o">=</span> <span class="n">transform_fn</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="__span-13-486"><a id="__codelineno-13-486" name="__codelineno-13-486"></a>        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="__span-13-487"><a id="__codelineno-13-487" name="__codelineno-13-487"></a>    <span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="__span-13-488"><a id="__codelineno-13-488" name="__codelineno-13-488"></a>    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inputs</span><span class="p">)}</span>
</span><span id="__span-13-489"><a id="__codelineno-13-489" name="__codelineno-13-489"></a>
</span><span id="__span-13-490"><a id="__codelineno-13-490" name="__codelineno-13-490"></a>    <span class="n">mol_smiles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-491"><a id="__codelineno-13-491" name="__codelineno-13-491"></a>    <span class="n">gen_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL_mode</span><span class="p">)</span>
</span><span id="__span-13-492"><a id="__codelineno-13-492" name="__codelineno-13-492"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"Dump figure in </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gen_dir</span><span class="p">))</span>
</span><span id="__span-13-493"><a id="__codelineno-13-493" name="__codelineno-13-493"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">gen_dir</span><span class="p">):</span>
</span><span id="__span-13-494"><a id="__codelineno-13-494" name="__codelineno-13-494"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">gen_dir</span><span class="p">)</span>
</span><span id="__span-13-495"><a id="__codelineno-13-495" name="__codelineno-13-495"></a>    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">inter_times</span><span class="p">):</span>
</span><span id="__span-13-496"><a id="__codelineno-13-496" name="__codelineno-13-496"></a>        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-13-497"><a id="__codelineno-13-497" name="__codelineno-13-497"></a>            <span class="n">gen_dir</span><span class="p">,</span> <span class="s2">"generated_interpolation-grid_molecules_seed</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span><span id="__span-13-498"><a id="__codelineno-13-498" name="__codelineno-13-498"></a>        <span class="p">)</span>
</span><span id="__span-13-499"><a id="__codelineno-13-499" name="__codelineno-13-499"></a>        <span class="n">visualize_interpolation</span><span class="p">(</span>
</span><span id="__span-13-500"><a id="__codelineno-13-500" name="__codelineno-13-500"></a>            <span class="n">filepath</span><span class="p">,</span>
</span><span id="__span-13-501"><a id="__codelineno-13-501" name="__codelineno-13-501"></a>            <span class="n">model</span><span class="p">,</span>
</span><span id="__span-13-502"><a id="__codelineno-13-502" name="__codelineno-13-502"></a>            <span class="n">mol_smiles</span><span class="o">=</span><span class="n">mol_smiles</span><span class="p">,</span>
</span><span id="__span-13-503"><a id="__codelineno-13-503" name="__codelineno-13-503"></a>            <span class="n">mols_per_row</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
</span><span id="__span-13-504"><a id="__codelineno-13-504" name="__codelineno-13-504"></a>            <span class="n">delta</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
</span><span id="__span-13-505"><a id="__codelineno-13-505" name="__codelineno-13-505"></a>            <span class="n">atomic_num_list</span><span class="o">=</span><span class="n">atomic_num_list</span><span class="p">,</span>
</span><span id="__span-13-506"><a id="__codelineno-13-506" name="__codelineno-13-506"></a>            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="__span-13-507"><a id="__codelineno-13-507" name="__codelineno-13-507"></a>            <span class="n">true_data</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="__span-13-508"><a id="__codelineno-13-508" name="__codelineno-13-508"></a>            <span class="n">data_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-13-509"><a id="__codelineno-13-509" name="__codelineno-13-509"></a>            <span class="n">keep_duplicate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-13-510"><a id="__codelineno-13-510" name="__codelineno-13-510"></a>        <span class="p">)</span>
</span><span id="__span-13-511"><a id="__codelineno-13-511" name="__codelineno-13-511"></a>        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-13-512"><a id="__codelineno-13-512" name="__codelineno-13-512"></a>            <span class="n">gen_dir</span><span class="p">,</span>
</span><span id="__span-13-513"><a id="__codelineno-13-513" name="__codelineno-13-513"></a>            <span class="s2">"generated_interpolation-grid_molecules_seed</span><span class="si">{}</span><span class="s2">_unique"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed</span><span class="p">),</span>
</span><span id="__span-13-514"><a id="__codelineno-13-514" name="__codelineno-13-514"></a>        <span class="p">)</span>
</span><span id="__span-13-515"><a id="__codelineno-13-515" name="__codelineno-13-515"></a>        <span class="n">visualize_interpolation</span><span class="p">(</span>
</span><span id="__span-13-516"><a id="__codelineno-13-516" name="__codelineno-13-516"></a>            <span class="n">filepath</span><span class="p">,</span>
</span><span id="__span-13-517"><a id="__codelineno-13-517" name="__codelineno-13-517"></a>            <span class="n">model</span><span class="p">,</span>
</span><span id="__span-13-518"><a id="__codelineno-13-518" name="__codelineno-13-518"></a>            <span class="n">mol_smiles</span><span class="o">=</span><span class="n">mol_smiles</span><span class="p">,</span>
</span><span id="__span-13-519"><a id="__codelineno-13-519" name="__codelineno-13-519"></a>            <span class="n">mols_per_row</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
</span><span id="__span-13-520"><a id="__codelineno-13-520" name="__codelineno-13-520"></a>            <span class="n">delta</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
</span><span id="__span-13-521"><a id="__codelineno-13-521" name="__codelineno-13-521"></a>            <span class="n">atomic_num_list</span><span class="o">=</span><span class="n">atomic_num_list</span><span class="p">,</span>
</span><span id="__span-13-522"><a id="__codelineno-13-522" name="__codelineno-13-522"></a>            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
</span><span id="__span-13-523"><a id="__codelineno-13-523" name="__codelineno-13-523"></a>            <span class="n">true_data</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="__span-13-524"><a id="__codelineno-13-524" name="__codelineno-13-524"></a>            <span class="n">data_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-13-525"><a id="__codelineno-13-525" name="__codelineno-13-525"></a>            <span class="n">keep_duplicate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-13-526"><a id="__codelineno-13-526" name="__codelineno-13-526"></a>        <span class="p">)</span>
</span><span id="__span-13-527"><a id="__codelineno-13-527" name="__codelineno-13-527"></a>    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-13-528"><a id="__codelineno-13-528" name="__codelineno-13-528"></a>
</span><span id="__span-13-529"><a id="__codelineno-13-529" name="__codelineno-13-529"></a><span class="n">inputs</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">input</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="38">3.8 模型的优化构建<a class="headerlink" href="#38" title="Permanent link">¶</a></h3>
<p>在模型完成训练后，进行分子优化和约束优化，训练一个额外的MLP模型，从潜空间到QED属性或者plogp属性，得到优化后的分子属性，并进行评估，受到与属性相似性的约束。如果首次运行的时候，会对选择的预训练模型进行优化训练，不同的属性存储的优化模型不同，QED属性保存为前缀为qed，plogp属性保存前缀为plogp，相关优优化模型将保存到指定文件夹下，第二次运行时将对优化后的模型进行评估。代码如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/optimize_moflow.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-470">470</a></span>
<span class="normal"><a href="#__codelineno-14-471">471</a></span>
<span class="normal"><a href="#__codelineno-14-472">472</a></span>
<span class="normal"><a href="#__codelineno-14-473">473</a></span>
<span class="normal"><a href="#__codelineno-14-474">474</a></span>
<span class="normal"><a href="#__codelineno-14-475">475</a></span>
<span class="normal"><a href="#__codelineno-14-476">476</a></span>
<span class="normal"><a href="#__codelineno-14-477">477</a></span>
<span class="normal"><a href="#__codelineno-14-478">478</a></span>
<span class="normal"><a href="#__codelineno-14-479">479</a></span>
<span class="normal"><a href="#__codelineno-14-480">480</a></span>
<span class="normal"><a href="#__codelineno-14-481">481</a></span>
<span class="normal"><a href="#__codelineno-14-482">482</a></span>
<span class="normal"><a href="#__codelineno-14-483">483</a></span>
<span class="normal"><a href="#__codelineno-14-484">484</a></span>
<span class="normal"><a href="#__codelineno-14-485">485</a></span>
<span class="normal"><a href="#__codelineno-14-486">486</a></span>
<span class="normal"><a href="#__codelineno-14-487">487</a></span>
<span class="normal"><a href="#__codelineno-14-488">488</a></span>
<span class="normal"><a href="#__codelineno-14-489">489</a></span>
<span class="normal"><a href="#__codelineno-14-490">490</a></span>
<span class="normal"><a href="#__codelineno-14-491">491</a></span>
<span class="normal"><a href="#__codelineno-14-492">492</a></span>
<span class="normal"><a href="#__codelineno-14-493">493</a></span>
<span class="normal"><a href="#__codelineno-14-494">494</a></span>
<span class="normal"><a href="#__codelineno-14-495">495</a></span>
<span class="normal"><a href="#__codelineno-14-496">496</a></span>
<span class="normal"><a href="#__codelineno-14-497">497</a></span>
<span class="normal"><a href="#__codelineno-14-498">498</a></span>
<span class="normal"><a href="#__codelineno-14-499">499</a></span>
<span class="normal"><a href="#__codelineno-14-500">500</a></span>
<span class="normal"><a href="#__codelineno-14-501">501</a></span>
<span class="normal"><a href="#__codelineno-14-502">502</a></span>
<span class="normal"><a href="#__codelineno-14-503">503</a></span>
<span class="normal"><a href="#__codelineno-14-504">504</a></span>
<span class="normal"><a href="#__codelineno-14-505">505</a></span>
<span class="normal"><a href="#__codelineno-14-506">506</a></span>
<span class="normal"><a href="#__codelineno-14-507">507</a></span>
<span class="normal"><a href="#__codelineno-14-508">508</a></span>
<span class="normal"><a href="#__codelineno-14-509">509</a></span>
<span class="normal"><a href="#__codelineno-14-510">510</a></span>
<span class="normal"><a href="#__codelineno-14-511">511</a></span>
<span class="normal"><a href="#__codelineno-14-512">512</a></span>
<span class="normal"><a href="#__codelineno-14-513">513</a></span>
<span class="normal"><a href="#__codelineno-14-514">514</a></span>
<span class="normal"><a href="#__codelineno-14-515">515</a></span>
<span class="normal"><a href="#__codelineno-14-516">516</a></span>
<span class="normal"><a href="#__codelineno-14-517">517</a></span>
<span class="normal"><a href="#__codelineno-14-518">518</a></span>
<span class="normal"><a href="#__codelineno-14-519">519</a></span>
<span class="normal"><a href="#__codelineno-14-520">520</a></span>
<span class="normal"><a href="#__codelineno-14-521">521</a></span>
<span class="normal"><a href="#__codelineno-14-522">522</a></span>
<span class="normal"><a href="#__codelineno-14-523">523</a></span>
<span class="normal"><a href="#__codelineno-14-524">524</a></span>
<span class="normal"><a href="#__codelineno-14-525">525</a></span>
<span class="normal"><a href="#__codelineno-14-526">526</a></span>
<span class="normal"><a href="#__codelineno-14-527">527</a></span>
<span class="normal"><a href="#__codelineno-14-528">528</a></span>
<span class="normal"><a href="#__codelineno-14-529">529</a></span>
<span class="normal"><a href="#__codelineno-14-530">530</a></span>
<span class="normal"><a href="#__codelineno-14-531">531</a></span>
<span class="normal"><a href="#__codelineno-14-532">532</a></span>
<span class="normal"><a href="#__codelineno-14-533">533</a></span>
<span class="normal"><a href="#__codelineno-14-534">534</a></span>
<span class="normal"><a href="#__codelineno-14-535">535</a></span>
<span class="normal"><a href="#__codelineno-14-536">536</a></span>
<span class="normal"><a href="#__codelineno-14-537">537</a></span>
<span class="normal"><a href="#__codelineno-14-538">538</a></span>
<span class="normal"><a href="#__codelineno-14-539">539</a></span>
<span class="normal"><a href="#__codelineno-14-540">540</a></span>
<span class="normal"><a href="#__codelineno-14-541">541</a></span>
<span class="normal"><a href="#__codelineno-14-542">542</a></span>
<span class="normal"><a href="#__codelineno-14-543">543</a></span>
<span class="normal"><a href="#__codelineno-14-544">544</a></span>
<span class="normal"><a href="#__codelineno-14-545">545</a></span>
<span class="normal"><a href="#__codelineno-14-546">546</a></span>
<span class="normal"><a href="#__codelineno-14-547">547</a></span>
<span class="normal"><a href="#__codelineno-14-548">548</a></span>
<span class="normal"><a href="#__codelineno-14-549">549</a></span>
<span class="normal"><a href="#__codelineno-14-550">550</a></span>
<span class="normal"><a href="#__codelineno-14-551">551</a></span>
<span class="normal"><a href="#__codelineno-14-552">552</a></span>
<span class="normal"><a href="#__codelineno-14-553">553</a></span>
<span class="normal"><a href="#__codelineno-14-554">554</a></span>
<span class="normal"><a href="#__codelineno-14-555">555</a></span>
<span class="normal"><a href="#__codelineno-14-556">556</a></span>
<span class="normal"><a href="#__codelineno-14-557">557</a></span>
<span class="normal"><a href="#__codelineno-14-558">558</a></span>
<span class="normal"><a href="#__codelineno-14-559">559</a></span>
<span class="normal"><a href="#__codelineno-14-560">560</a></span>
<span class="normal"><a href="#__codelineno-14-561">561</a></span>
<span class="normal"><a href="#__codelineno-14-562">562</a></span>
<span class="normal"><a href="#__codelineno-14-563">563</a></span>
<span class="normal"><a href="#__codelineno-14-564">564</a></span>
<span class="normal"><a href="#__codelineno-14-565">565</a></span>
<span class="normal"><a href="#__codelineno-14-566">566</a></span>
<span class="normal"><a href="#__codelineno-14-567">567</a></span>
<span class="normal"><a href="#__codelineno-14-568">568</a></span>
<span class="normal"><a href="#__codelineno-14-569">569</a></span>
<span class="normal"><a href="#__codelineno-14-570">570</a></span>
<span class="normal"><a href="#__codelineno-14-571">571</a></span>
<span class="normal"><a href="#__codelineno-14-572">572</a></span>
<span class="normal"><a href="#__codelineno-14-573">573</a></span>
<span class="normal"><a href="#__codelineno-14-574">574</a></span>
<span class="normal"><a href="#__codelineno-14-575">575</a></span>
<span class="normal"><a href="#__codelineno-14-576">576</a></span>
<span class="normal"><a href="#__codelineno-14-577">577</a></span>
<span class="normal"><a href="#__codelineno-14-578">578</a></span>
<span class="normal"><a href="#__codelineno-14-579">579</a></span>
<span class="normal"><a href="#__codelineno-14-580">580</a></span>
<span class="normal"><a href="#__codelineno-14-581">581</a></span>
<span class="normal"><a href="#__codelineno-14-582">582</a></span>
<span class="normal"><a href="#__codelineno-14-583">583</a></span>
<span class="normal"><a href="#__codelineno-14-584">584</a></span>
<span class="normal"><a href="#__codelineno-14-585">585</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-470"><a id="__codelineno-14-470" name="__codelineno-14-470"></a><span class="c1"># set dataloader config</span>
</span><span id="__span-14-471"><a id="__codelineno-14-471" name="__codelineno-14-471"></a><span class="n">dataloader_cfg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-14-472"><a id="__codelineno-14-472" name="__codelineno-14-472"></a>    <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-473"><a id="__codelineno-14-473" name="__codelineno-14-473"></a>        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"MOlFLOWDataset"</span><span class="p">,</span>
</span><span id="__span-14-474"><a id="__codelineno-14-474" name="__codelineno-14-474"></a>        <span class="s2">"file_path"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span>
</span><span id="__span-14-475"><a id="__codelineno-14-475" name="__codelineno-14-475"></a>        <span class="s2">"data_name"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-14-476"><a id="__codelineno-14-476" name="__codelineno-14-476"></a>        <span class="s2">"mode"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
</span><span id="__span-14-477"><a id="__codelineno-14-477" name="__codelineno-14-477"></a>        <span class="s2">"valid_idx"</span><span class="p">:</span> <span class="n">valid_idx</span><span class="p">,</span>
</span><span id="__span-14-478"><a id="__codelineno-14-478" name="__codelineno-14-478"></a>        <span class="s2">"input_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">input_keys</span><span class="p">,</span>
</span><span id="__span-14-479"><a id="__codelineno-14-479" name="__codelineno-14-479"></a>        <span class="s2">"label_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">label_keys</span><span class="p">,</span>
</span><span id="__span-14-480"><a id="__codelineno-14-480" name="__codelineno-14-480"></a>        <span class="s2">"smiles_col"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
</span><span id="__span-14-481"><a id="__codelineno-14-481" name="__codelineno-14-481"></a>        <span class="s2">"transform_fn"</span><span class="p">:</span> <span class="n">transform_fn</span><span class="p">,</span>
</span><span id="__span-14-482"><a id="__codelineno-14-482" name="__codelineno-14-482"></a>    <span class="p">},</span>
</span><span id="__span-14-483"><a id="__codelineno-14-483" name="__codelineno-14-483"></a>    <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-14-484"><a id="__codelineno-14-484" name="__codelineno-14-484"></a>        <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-14-485"><a id="__codelineno-14-485" name="__codelineno-14-485"></a>        <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-14-486"><a id="__codelineno-14-486" name="__codelineno-14-486"></a>        <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-14-487"><a id="__codelineno-14-487" name="__codelineno-14-487"></a>    <span class="p">},</span>
</span><span id="__span-14-488"><a id="__codelineno-14-488" name="__codelineno-14-488"></a>    <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-14-489"><a id="__codelineno-14-489" name="__codelineno-14-489"></a>    <span class="s2">"num_workers"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-14-490"><a id="__codelineno-14-490" name="__codelineno-14-490"></a><span class="p">}</span>
</span><span id="__span-14-491"><a id="__codelineno-14-491" name="__codelineno-14-491"></a>
</span><span id="__span-14-492"><a id="__codelineno-14-492" name="__codelineno-14-492"></a><span class="c1"># set model</span>
</span><span id="__span-14-493"><a id="__codelineno-14-493" name="__codelineno-14-493"></a><span class="n">model_cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="p">)</span>
</span><span id="__span-14-494"><a id="__codelineno-14-494" name="__codelineno-14-494"></a><span class="n">model_cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"hyper_params"</span><span class="p">:</span> <span class="n">model_params</span><span class="p">})</span>
</span><span id="__span-14-495"><a id="__codelineno-14-495" name="__codelineno-14-495"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">MoFlowNet</span><span class="p">(</span><span class="o">**</span><span class="n">model_cfg</span><span class="p">)</span>
</span><span id="__span-14-496"><a id="__codelineno-14-496" name="__codelineno-14-496"></a><span class="n">ppsci</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">save_load</span><span class="o">.</span><span class="n">load_pretrain</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">pretrained_model_path</span><span class="p">)</span>
</span><span id="__span-14-497"><a id="__codelineno-14-497" name="__codelineno-14-497"></a>
</span><span id="__span-14-498"><a id="__codelineno-14-498" name="__codelineno-14-498"></a><span class="n">model_prop_cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL_Prop</span><span class="p">)</span>
</span><span id="__span-14-499"><a id="__codelineno-14-499" name="__codelineno-14-499"></a><span class="n">model_prop_cfg</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="__span-14-500"><a id="__codelineno-14-500" name="__codelineno-14-500"></a>    <span class="p">{</span>
</span><span id="__span-14-501"><a id="__codelineno-14-501" name="__codelineno-14-501"></a>        <span class="s2">"model"</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
</span><span id="__span-14-502"><a id="__codelineno-14-502" name="__codelineno-14-502"></a>        <span class="s2">"hidden_size"</span><span class="p">:</span> <span class="n">hidden</span><span class="p">,</span>
</span><span id="__span-14-503"><a id="__codelineno-14-503" name="__codelineno-14-503"></a>    <span class="p">}</span>
</span><span id="__span-14-504"><a id="__codelineno-14-504" name="__codelineno-14-504"></a><span class="p">)</span>
</span><span id="__span-14-505"><a id="__codelineno-14-505" name="__codelineno-14-505"></a><span class="n">property_model</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">MoFlowProp</span><span class="p">(</span><span class="o">**</span><span class="n">model_prop_cfg</span><span class="p">)</span>
</span><span id="__span-14-506"><a id="__codelineno-14-506" name="__codelineno-14-506"></a><span class="n">train</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">build_dataset</span><span class="p">(</span><span class="n">dataloader_cfg</span><span class="p">[</span><span class="s2">"dataset"</span><span class="p">])</span>
</span><span id="__span-14-507"><a id="__codelineno-14-507" name="__codelineno-14-507"></a><span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">build_dataloader</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">dataloader_cfg</span><span class="p">)</span>
</span><span id="__span-14-508"><a id="__codelineno-14-508" name="__codelineno-14-508"></a><span class="n">train_idx</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">train_idx</span>
</span><span id="__span-14-509"><a id="__codelineno-14-509" name="__codelineno-14-509"></a><span class="n">property_model_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-14-510"><a id="__codelineno-14-510" name="__codelineno-14-510"></a>    <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">_model.pdparams"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">property_name</span><span class="p">)</span>
</span><span id="__span-14-511"><a id="__codelineno-14-511" name="__codelineno-14-511"></a><span class="p">)</span>
</span><span id="__span-14-512"><a id="__codelineno-14-512" name="__codelineno-14-512"></a>
</span><span id="__span-14-513"><a id="__codelineno-14-513" name="__codelineno-14-513"></a><span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">property_model_path</span><span class="p">):</span>
</span><span id="__span-14-514"><a id="__codelineno-14-514" name="__codelineno-14-514"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"Training regression model over molecular embedding:"</span><span class="p">)</span>
</span><span id="__span-14-515"><a id="__codelineno-14-515" name="__codelineno-14-515"></a>    <span class="n">property_csv_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-14-516"><a id="__codelineno-14-516" name="__codelineno-14-516"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">_property.csv"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span>
</span><span id="__span-14-517"><a id="__codelineno-14-517" name="__codelineno-14-517"></a>    <span class="p">)</span>
</span><span id="__span-14-518"><a id="__codelineno-14-518" name="__codelineno-14-518"></a>    <span class="n">prop_list</span> <span class="o">=</span> <span class="n">load_property_csv</span><span class="p">(</span><span class="n">property_csv_path</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-14-519"><a id="__codelineno-14-519" name="__codelineno-14-519"></a>    <span class="n">train_prop</span> <span class="o">=</span> <span class="p">[</span><span class="n">prop_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">train_idx</span><span class="p">]</span>
</span><span id="__span-14-520"><a id="__codelineno-14-520" name="__codelineno-14-520"></a>    <span class="c1"># test_prop = [prop_list[i] for i in valid_idx]</span>
</span><span id="__span-14-521"><a id="__codelineno-14-521" name="__codelineno-14-521"></a>
</span><span id="__span-14-522"><a id="__codelineno-14-522" name="__codelineno-14-522"></a>    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
</span><span id="__span-14-523"><a id="__codelineno-14-523" name="__codelineno-14-523"></a>    <span class="n">property_model</span> <span class="o">=</span> <span class="n">fit_model</span><span class="p">(</span>
</span><span id="__span-14-524"><a id="__codelineno-14-524" name="__codelineno-14-524"></a>        <span class="n">property_model</span><span class="p">,</span>
</span><span id="__span-14-525"><a id="__codelineno-14-525" name="__codelineno-14-525"></a>        <span class="n">train_dataloader</span><span class="p">,</span>
</span><span id="__span-14-526"><a id="__codelineno-14-526" name="__codelineno-14-526"></a>        <span class="n">train_prop</span><span class="p">,</span>
</span><span id="__span-14-527"><a id="__codelineno-14-527" name="__codelineno-14-527"></a>        <span class="n">N</span><span class="p">,</span>
</span><span id="__span-14-528"><a id="__codelineno-14-528" name="__codelineno-14-528"></a>        <span class="n">property_name</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">property_name</span><span class="p">,</span>
</span><span id="__span-14-529"><a id="__codelineno-14-529" name="__codelineno-14-529"></a>        <span class="n">max_epochs</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
</span><span id="__span-14-530"><a id="__codelineno-14-530" name="__codelineno-14-530"></a>        <span class="n">learning_rate</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
</span><span id="__span-14-531"><a id="__codelineno-14-531" name="__codelineno-14-531"></a>        <span class="n">weight_decay</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">weight_decay</span><span class="p">,</span>
</span><span id="__span-14-532"><a id="__codelineno-14-532" name="__codelineno-14-532"></a>    <span class="p">)</span>
</span><span id="__span-14-533"><a id="__codelineno-14-533" name="__codelineno-14-533"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
</span><span id="__span-14-534"><a id="__codelineno-14-534" name="__codelineno-14-534"></a>        <span class="s2">"saving </span><span class="si">{}</span><span class="s2"> regression model to: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-14-535"><a id="__codelineno-14-535" name="__codelineno-14-535"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">property_name</span><span class="p">,</span> <span class="n">property_model_path</span>
</span><span id="__span-14-536"><a id="__codelineno-14-536" name="__codelineno-14-536"></a>        <span class="p">)</span>
</span><span id="__span-14-537"><a id="__codelineno-14-537" name="__codelineno-14-537"></a>    <span class="p">)</span>
</span><span id="__span-14-538"><a id="__codelineno-14-538" name="__codelineno-14-538"></a>    <span class="n">paddle</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">property_model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span><span class="o">=</span><span class="n">property_model_path</span><span class="p">)</span>
</span><span id="__span-14-539"><a id="__codelineno-14-539" name="__codelineno-14-539"></a>
</span><span id="__span-14-540"><a id="__codelineno-14-540" name="__codelineno-14-540"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-14-541"><a id="__codelineno-14-541" name="__codelineno-14-541"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"Loading trained regression model for optimization"</span><span class="p">)</span>
</span><span id="__span-14-542"><a id="__codelineno-14-542" name="__codelineno-14-542"></a>    <span class="n">property_csv_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-14-543"><a id="__codelineno-14-543" name="__codelineno-14-543"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="s2">"</span><span class="si">{}</span><span class="s2">_property.csv"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span>
</span><span id="__span-14-544"><a id="__codelineno-14-544" name="__codelineno-14-544"></a>    <span class="p">)</span>
</span><span id="__span-14-545"><a id="__codelineno-14-545" name="__codelineno-14-545"></a>    <span class="n">prop_list</span> <span class="o">=</span> <span class="n">load_property_csv</span><span class="p">(</span><span class="n">property_csv_path</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-14-546"><a id="__codelineno-14-546" name="__codelineno-14-546"></a>    <span class="n">train_prop</span> <span class="o">=</span> <span class="p">[</span><span class="n">prop_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">train_idx</span><span class="p">]</span>
</span><span id="__span-14-547"><a id="__codelineno-14-547" name="__codelineno-14-547"></a>    <span class="c1"># test_prop = [prop_list[i] for i in valid_idx]</span>
</span><span id="__span-14-548"><a id="__codelineno-14-548" name="__codelineno-14-548"></a>
</span><span id="__span-14-549"><a id="__codelineno-14-549" name="__codelineno-14-549"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span>
</span><span id="__span-14-550"><a id="__codelineno-14-550" name="__codelineno-14-550"></a>        <span class="s2">"loading </span><span class="si">{}</span><span class="s2"> regression model from: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-14-551"><a id="__codelineno-14-551" name="__codelineno-14-551"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">property_name</span><span class="p">,</span> <span class="n">property_model_path</span>
</span><span id="__span-14-552"><a id="__codelineno-14-552" name="__codelineno-14-552"></a>        <span class="p">)</span>
</span><span id="__span-14-553"><a id="__codelineno-14-553" name="__codelineno-14-553"></a>    <span class="p">)</span>
</span><span id="__span-14-554"><a id="__codelineno-14-554" name="__codelineno-14-554"></a>
</span><span id="__span-14-555"><a id="__codelineno-14-555" name="__codelineno-14-555"></a>    <span class="n">state_dict</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">property_model_path</span><span class="p">)</span>
</span><span id="__span-14-556"><a id="__codelineno-14-556" name="__codelineno-14-556"></a>    <span class="n">property_model</span><span class="o">.</span><span class="n">set_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
</span><span id="__span-14-557"><a id="__codelineno-14-557" name="__codelineno-14-557"></a>    <span class="n">property_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-14-558"><a id="__codelineno-14-558" name="__codelineno-14-558"></a>    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-14-559"><a id="__codelineno-14-559" name="__codelineno-14-559"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">topscore</span><span class="p">:</span>
</span><span id="__span-14-560"><a id="__codelineno-14-560" name="__codelineno-14-560"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"Finding top score:"</span><span class="p">)</span>
</span><span id="__span-14-561"><a id="__codelineno-14-561" name="__codelineno-14-561"></a>        <span class="n">find_top_score_smiles</span><span class="p">(</span>
</span><span id="__span-14-562"><a id="__codelineno-14-562" name="__codelineno-14-562"></a>            <span class="n">model</span><span class="p">,</span>
</span><span id="__span-14-563"><a id="__codelineno-14-563" name="__codelineno-14-563"></a>            <span class="n">property_model</span><span class="p">,</span>
</span><span id="__span-14-564"><a id="__codelineno-14-564" name="__codelineno-14-564"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-14-565"><a id="__codelineno-14-565" name="__codelineno-14-565"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">property_name</span><span class="p">,</span>
</span><span id="__span-14-566"><a id="__codelineno-14-566" name="__codelineno-14-566"></a>            <span class="n">train_prop</span><span class="p">,</span>
</span><span id="__span-14-567"><a id="__codelineno-14-567" name="__codelineno-14-567"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span>
</span><span id="__span-14-568"><a id="__codelineno-14-568" name="__codelineno-14-568"></a>            <span class="n">atomic_num_list</span><span class="p">,</span>
</span><span id="__span-14-569"><a id="__codelineno-14-569" name="__codelineno-14-569"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
</span><span id="__span-14-570"><a id="__codelineno-14-570" name="__codelineno-14-570"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
</span><span id="__span-14-571"><a id="__codelineno-14-571" name="__codelineno-14-571"></a>        <span class="p">)</span>
</span><span id="__span-14-572"><a id="__codelineno-14-572" name="__codelineno-14-572"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">consopt</span><span class="p">:</span>
</span><span id="__span-14-573"><a id="__codelineno-14-573" name="__codelineno-14-573"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s2">"Constrained optimization:"</span><span class="p">)</span>
</span><span id="__span-14-574"><a id="__codelineno-14-574" name="__codelineno-14-574"></a>        <span class="n">constrain_optimization_smiles</span><span class="p">(</span>
</span><span id="__span-14-575"><a id="__codelineno-14-575" name="__codelineno-14-575"></a>            <span class="n">model</span><span class="p">,</span>
</span><span id="__span-14-576"><a id="__codelineno-14-576" name="__codelineno-14-576"></a>            <span class="n">property_model</span><span class="p">,</span>
</span><span id="__span-14-577"><a id="__codelineno-14-577" name="__codelineno-14-577"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-14-578"><a id="__codelineno-14-578" name="__codelineno-14-578"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">property_name</span><span class="p">,</span>
</span><span id="__span-14-579"><a id="__codelineno-14-579" name="__codelineno-14-579"></a>            <span class="n">train_prop</span><span class="p">,</span>
</span><span id="__span-14-580"><a id="__codelineno-14-580" name="__codelineno-14-580"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span>
</span><span id="__span-14-581"><a id="__codelineno-14-581" name="__codelineno-14-581"></a>            <span class="n">atomic_num_list</span><span class="p">,</span>
</span><span id="__span-14-582"><a id="__codelineno-14-582" name="__codelineno-14-582"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
</span><span id="__span-14-583"><a id="__codelineno-14-583" name="__codelineno-14-583"></a>            <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
</span><span id="__span-14-584"><a id="__codelineno-14-584" name="__codelineno-14-584"></a>            <span class="n">sim_cutoff</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">OPTIMIZE</span><span class="o">.</span><span class="n">sim_cutoff</span><span class="p">,</span>
</span><span id="__span-14-585"><a id="__codelineno-14-585" name="__codelineno-14-585"></a>        <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>主要参数与训练相似，需要单独进行评估参数的设置，参数通过配置文件进行设置如下：</p>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/conf/moflow_optimize.yaml</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-15-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-15-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-15-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-15-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-15-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-15-100">100</a></span>
<span class="normal"><a href="#__codelineno-15-101">101</a></span>
<span class="normal"><a href="#__codelineno-15-102">102</a></span>
<span class="normal"><a href="#__codelineno-15-103">103</a></span>
<span class="normal"><a href="#__codelineno-15-104">104</a></span>
<span class="normal"><a href="#__codelineno-15-105">105</a></span>
<span class="normal"><a href="#__codelineno-15-106">106</a></span>
<span class="normal"><a href="#__codelineno-15-107">107</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-94"><a id="__codelineno-15-94" name="__codelineno-15-94"></a><span class="c1"># optimize settings</span>
</span><span id="__span-15-95"><a id="__codelineno-15-95" name="__codelineno-15-95"></a><span class="n">OPTIMIZE</span><span class="p">:</span>
</span><span id="__span-15-96"><a id="__codelineno-15-96" name="__codelineno-15-96"></a>  <span class="n">property_name</span><span class="p">:</span> <span class="n">plogp</span> <span class="c1"># qed/plogp</span>
</span><span id="__span-15-97"><a id="__codelineno-15-97" name="__codelineno-15-97"></a>  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">256</span>
</span><span id="__span-15-98"><a id="__codelineno-15-98" name="__codelineno-15-98"></a>  <span class="n">topk</span><span class="p">:</span> <span class="mi">800</span>
</span><span id="__span-15-99"><a id="__codelineno-15-99" name="__codelineno-15-99"></a>  <span class="n">debug</span><span class="p">:</span> <span class="n">false</span>
</span><span id="__span-15-100"><a id="__codelineno-15-100" name="__codelineno-15-100"></a>  <span class="n">topscore</span><span class="p">:</span> <span class="n">false</span>
</span><span id="__span-15-101"><a id="__codelineno-15-101" name="__codelineno-15-101"></a>  <span class="n">max_epochs</span><span class="p">:</span> <span class="mi">3</span>
</span><span id="__span-15-102"><a id="__codelineno-15-102" name="__codelineno-15-102"></a>  <span class="n">learning_rate</span><span class="p">:</span> <span class="mf">0.001</span>
</span><span id="__span-15-103"><a id="__codelineno-15-103" name="__codelineno-15-103"></a>  <span class="n">weight_decay</span><span class="p">:</span> <span class="mf">1e-2</span>
</span><span id="__span-15-104"><a id="__codelineno-15-104" name="__codelineno-15-104"></a>  <span class="n">hidden</span><span class="p">:</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="c1"># Hidden dimension list for output regression</span>
</span><span id="__span-15-105"><a id="__codelineno-15-105" name="__codelineno-15-105"></a>  <span class="n">temperature</span><span class="p">:</span> <span class="mf">1.0</span>
</span><span id="__span-15-106"><a id="__codelineno-15-106" name="__codelineno-15-106"></a>  <span class="n">consopt</span><span class="p">:</span> <span class="n">true</span>
</span><span id="__span-15-107"><a id="__codelineno-15-107" name="__codelineno-15-107"></a>  <span class="n">sim_cutoff</span><span class="p">:</span> <span class="mf">0.0</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="4">4. 训练完整代码<a class="headerlink" href="#4" title="Permanent link">¶</a></h2>
<div class="language-py highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">examples/moflow/moflow_train.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">  1</a></span>
<span class="normal"><a href="#__codelineno-16-2">  2</a></span>
<span class="normal"><a href="#__codelineno-16-3">  3</a></span>
<span class="normal"><a href="#__codelineno-16-4">  4</a></span>
<span class="normal"><a href="#__codelineno-16-5">  5</a></span>
<span class="normal"><a href="#__codelineno-16-6">  6</a></span>
<span class="normal"><a href="#__codelineno-16-7">  7</a></span>
<span class="normal"><a href="#__codelineno-16-8">  8</a></span>
<span class="normal"><a href="#__codelineno-16-9">  9</a></span>
<span class="normal"><a href="#__codelineno-16-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-16-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-16-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-16-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-16-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-16-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-16-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-16-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-16-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-16-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-16-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-16-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-16-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-16-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-16-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-16-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-16-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-16-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-16-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-16-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-16-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-16-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-16-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-16-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-16-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-16-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-16-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-16-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-16-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-16-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-16-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-16-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-16-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-16-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-16-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-16-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-16-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-16-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-16-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-16-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-16-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-16-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-16-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-16-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-16-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-16-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-16-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-16-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-16-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-16-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-16-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-16-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-16-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-16-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-16-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-16-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-16-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-16-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-16-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-16-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-16-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-16-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-16-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-16-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-16-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-16-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-16-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-16-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-16-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-16-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-16-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-16-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-16-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-16-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-16-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-16-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-16-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-16-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-16-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-16-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-16-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-16-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-16-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-16-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-16-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-16-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-16-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-16-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-16-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-16-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-16-100">100</a></span>
<span class="normal"><a href="#__codelineno-16-101">101</a></span>
<span class="normal"><a href="#__codelineno-16-102">102</a></span>
<span class="normal"><a href="#__codelineno-16-103">103</a></span>
<span class="normal"><a href="#__codelineno-16-104">104</a></span>
<span class="normal"><a href="#__codelineno-16-105">105</a></span>
<span class="normal"><a href="#__codelineno-16-106">106</a></span>
<span class="normal"><a href="#__codelineno-16-107">107</a></span>
<span class="normal"><a href="#__codelineno-16-108">108</a></span>
<span class="normal"><a href="#__codelineno-16-109">109</a></span>
<span class="normal"><a href="#__codelineno-16-110">110</a></span>
<span class="normal"><a href="#__codelineno-16-111">111</a></span>
<span class="normal"><a href="#__codelineno-16-112">112</a></span>
<span class="normal"><a href="#__codelineno-16-113">113</a></span>
<span class="normal"><a href="#__codelineno-16-114">114</a></span>
<span class="normal"><a href="#__codelineno-16-115">115</a></span>
<span class="normal"><a href="#__codelineno-16-116">116</a></span>
<span class="normal"><a href="#__codelineno-16-117">117</a></span>
<span class="normal"><a href="#__codelineno-16-118">118</a></span>
<span class="normal"><a href="#__codelineno-16-119">119</a></span>
<span class="normal"><a href="#__codelineno-16-120">120</a></span>
<span class="normal"><a href="#__codelineno-16-121">121</a></span>
<span class="normal"><a href="#__codelineno-16-122">122</a></span>
<span class="normal"><a href="#__codelineno-16-123">123</a></span>
<span class="normal"><a href="#__codelineno-16-124">124</a></span>
<span class="normal"><a href="#__codelineno-16-125">125</a></span>
<span class="normal"><a href="#__codelineno-16-126">126</a></span>
<span class="normal"><a href="#__codelineno-16-127">127</a></span>
<span class="normal"><a href="#__codelineno-16-128">128</a></span>
<span class="normal"><a href="#__codelineno-16-129">129</a></span>
<span class="normal"><a href="#__codelineno-16-130">130</a></span>
<span class="normal"><a href="#__codelineno-16-131">131</a></span>
<span class="normal"><a href="#__codelineno-16-132">132</a></span>
<span class="normal"><a href="#__codelineno-16-133">133</a></span>
<span class="normal"><a href="#__codelineno-16-134">134</a></span>
<span class="normal"><a href="#__codelineno-16-135">135</a></span>
<span class="normal"><a href="#__codelineno-16-136">136</a></span>
<span class="normal"><a href="#__codelineno-16-137">137</a></span>
<span class="normal"><a href="#__codelineno-16-138">138</a></span>
<span class="normal"><a href="#__codelineno-16-139">139</a></span>
<span class="normal"><a href="#__codelineno-16-140">140</a></span>
<span class="normal"><a href="#__codelineno-16-141">141</a></span>
<span class="normal"><a href="#__codelineno-16-142">142</a></span>
<span class="normal"><a href="#__codelineno-16-143">143</a></span>
<span class="normal"><a href="#__codelineno-16-144">144</a></span>
<span class="normal"><a href="#__codelineno-16-145">145</a></span>
<span class="normal"><a href="#__codelineno-16-146">146</a></span>
<span class="normal"><a href="#__codelineno-16-147">147</a></span>
<span class="normal"><a href="#__codelineno-16-148">148</a></span>
<span class="normal"><a href="#__codelineno-16-149">149</a></span>
<span class="normal"><a href="#__codelineno-16-150">150</a></span>
<span class="normal"><a href="#__codelineno-16-151">151</a></span>
<span class="normal"><a href="#__codelineno-16-152">152</a></span>
<span class="normal"><a href="#__codelineno-16-153">153</a></span>
<span class="normal"><a href="#__codelineno-16-154">154</a></span>
<span class="normal"><a href="#__codelineno-16-155">155</a></span>
<span class="normal"><a href="#__codelineno-16-156">156</a></span>
<span class="normal"><a href="#__codelineno-16-157">157</a></span>
<span class="normal"><a href="#__codelineno-16-158">158</a></span>
<span class="normal"><a href="#__codelineno-16-159">159</a></span>
<span class="normal"><a href="#__codelineno-16-160">160</a></span>
<span class="normal"><a href="#__codelineno-16-161">161</a></span>
<span class="normal"><a href="#__codelineno-16-162">162</a></span>
<span class="normal"><a href="#__codelineno-16-163">163</a></span>
<span class="normal"><a href="#__codelineno-16-164">164</a></span>
<span class="normal"><a href="#__codelineno-16-165">165</a></span>
<span class="normal"><a href="#__codelineno-16-166">166</a></span>
<span class="normal"><a href="#__codelineno-16-167">167</a></span>
<span class="normal"><a href="#__codelineno-16-168">168</a></span>
<span class="normal"><a href="#__codelineno-16-169">169</a></span>
<span class="normal"><a href="#__codelineno-16-170">170</a></span>
<span class="normal"><a href="#__codelineno-16-171">171</a></span>
<span class="normal"><a href="#__codelineno-16-172">172</a></span>
<span class="normal"><a href="#__codelineno-16-173">173</a></span>
<span class="normal"><a href="#__codelineno-16-174">174</a></span>
<span class="normal"><a href="#__codelineno-16-175">175</a></span>
<span class="normal"><a href="#__codelineno-16-176">176</a></span>
<span class="normal"><a href="#__codelineno-16-177">177</a></span>
<span class="normal"><a href="#__codelineno-16-178">178</a></span>
<span class="normal"><a href="#__codelineno-16-179">179</a></span>
<span class="normal"><a href="#__codelineno-16-180">180</a></span>
<span class="normal"><a href="#__codelineno-16-181">181</a></span>
<span class="normal"><a href="#__codelineno-16-182">182</a></span>
<span class="normal"><a href="#__codelineno-16-183">183</a></span>
<span class="normal"><a href="#__codelineno-16-184">184</a></span>
<span class="normal"><a href="#__codelineno-16-185">185</a></span>
<span class="normal"><a href="#__codelineno-16-186">186</a></span>
<span class="normal"><a href="#__codelineno-16-187">187</a></span>
<span class="normal"><a href="#__codelineno-16-188">188</a></span>
<span class="normal"><a href="#__codelineno-16-189">189</a></span>
<span class="normal"><a href="#__codelineno-16-190">190</a></span>
<span class="normal"><a href="#__codelineno-16-191">191</a></span>
<span class="normal"><a href="#__codelineno-16-192">192</a></span>
<span class="normal"><a href="#__codelineno-16-193">193</a></span>
<span class="normal"><a href="#__codelineno-16-194">194</a></span>
<span class="normal"><a href="#__codelineno-16-195">195</a></span>
<span class="normal"><a href="#__codelineno-16-196">196</a></span>
<span class="normal"><a href="#__codelineno-16-197">197</a></span>
<span class="normal"><a href="#__codelineno-16-198">198</a></span>
<span class="normal"><a href="#__codelineno-16-199">199</a></span>
<span class="normal"><a href="#__codelineno-16-200">200</a></span>
<span class="normal"><a href="#__codelineno-16-201">201</a></span>
<span class="normal"><a href="#__codelineno-16-202">202</a></span>
<span class="normal"><a href="#__codelineno-16-203">203</a></span>
<span class="normal"><a href="#__codelineno-16-204">204</a></span>
<span class="normal"><a href="#__codelineno-16-205">205</a></span>
<span class="normal"><a href="#__codelineno-16-206">206</a></span>
<span class="normal"><a href="#__codelineno-16-207">207</a></span>
<span class="normal"><a href="#__codelineno-16-208">208</a></span>
<span class="normal"><a href="#__codelineno-16-209">209</a></span>
<span class="normal"><a href="#__codelineno-16-210">210</a></span>
<span class="normal"><a href="#__codelineno-16-211">211</a></span>
<span class="normal"><a href="#__codelineno-16-212">212</a></span>
<span class="normal"><a href="#__codelineno-16-213">213</a></span>
<span class="normal"><a href="#__codelineno-16-214">214</a></span>
<span class="normal"><a href="#__codelineno-16-215">215</a></span>
<span class="normal"><a href="#__codelineno-16-216">216</a></span>
<span class="normal"><a href="#__codelineno-16-217">217</a></span>
<span class="normal"><a href="#__codelineno-16-218">218</a></span>
<span class="normal"><a href="#__codelineno-16-219">219</a></span>
<span class="normal"><a href="#__codelineno-16-220">220</a></span>
<span class="normal"><a href="#__codelineno-16-221">221</a></span>
<span class="normal"><a href="#__codelineno-16-222">222</a></span>
<span class="normal"><a href="#__codelineno-16-223">223</a></span>
<span class="normal"><a href="#__codelineno-16-224">224</a></span>
<span class="normal"><a href="#__codelineno-16-225">225</a></span>
<span class="normal"><a href="#__codelineno-16-226">226</a></span>
<span class="normal"><a href="#__codelineno-16-227">227</a></span>
<span class="normal"><a href="#__codelineno-16-228">228</a></span>
<span class="normal"><a href="#__codelineno-16-229">229</a></span>
<span class="normal"><a href="#__codelineno-16-230">230</a></span>
<span class="normal"><a href="#__codelineno-16-231">231</a></span>
<span class="normal"><a href="#__codelineno-16-232">232</a></span>
<span class="normal"><a href="#__codelineno-16-233">233</a></span>
<span class="normal"><a href="#__codelineno-16-234">234</a></span>
<span class="normal"><a href="#__codelineno-16-235">235</a></span>
<span class="normal"><a href="#__codelineno-16-236">236</a></span>
<span class="normal"><a href="#__codelineno-16-237">237</a></span>
<span class="normal"><a href="#__codelineno-16-238">238</a></span>
<span class="normal"><a href="#__codelineno-16-239">239</a></span>
<span class="normal"><a href="#__codelineno-16-240">240</a></span>
<span class="normal"><a href="#__codelineno-16-241">241</a></span>
<span class="normal"><a href="#__codelineno-16-242">242</a></span>
<span class="normal"><a href="#__codelineno-16-243">243</a></span>
<span class="normal"><a href="#__codelineno-16-244">244</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1"># Copyright (c) 2024 PaddlePaddle Authors. All Rights Reserved.</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="c1"># Licensed under the Apache License, Version 2.0 (the "License");</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="c1"># you may not use this file except in compliance with the License.</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="c1"># You may obtain a copy of the License at</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="c1"># distributed under the License is distributed on an "AS IS" BASIS,</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="c1"># See the License for the specific language governing permissions and</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="c1"># limitations under the License.</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14"></a>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span> <span class="k">as</span> <span class="n">osp</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16"></a>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="kn">import</span> <span class="nn">hydra</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="kn">import</span> <span class="nn">moflow_transform</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="kn">import</span> <span class="nn">paddle</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="kn">from</span> <span class="nn">moflow_utils</span> <span class="kn">import</span> <span class="n">Hyperparameters</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="kn">from</span> <span class="nn">moflow_utils</span> <span class="kn">import</span> <span class="n">check_validity</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="kn">from</span> <span class="nn">omegaconf</span> <span class="kn">import</span> <span class="n">DictConfig</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25"></a>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="kn">import</span> <span class="nn">ppsci</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="kn">from</span> <span class="nn">ppsci.utils</span> <span class="kn">import</span> <span class="n">logger</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28"></a>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29"></a>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="k">def</span> <span class="nf">infer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">z_mu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">true_adj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">    </span><span class="sd">"""generate mols</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="sd">    Args:</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="sd">        model (object): Generated eval Moflownet model</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a><span class="sd">        batch_size (int, optional): Batch size during evaling per GPU. Defaults to 20.</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="sd">        temp (float, optional): temperature of the gaussian distribution. Defaults to 0.7.</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="sd">        z_mu (int, optional): latent vector of a molecule. Defaults to None.</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="sd">        true_adj (paddle.Tensor, optional): True Adjacency. Defaults to None.</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="sd">    Returns:</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41"></a><span class="sd">        Tuple(paddle.Tensor, paddle.Tensor): Adjacency and nodes</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="sd">    """</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43"></a>    <span class="n">z_dim</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">b_size</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">a_size</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44"></a>    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">z_dim</span><span class="p">)</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45"></a>    <span class="n">sigma_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">z_dim</span><span class="p">)</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46"></a>    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">hyper_params</span><span class="o">.</span><span class="n">learn_dist</span><span class="p">:</span>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ln_var</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48"></a>            <span class="n">sigma_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ln_var</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span> <span class="o">*</span> <span class="n">sigma_diag</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49"></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ln_var</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50"></a>            <span class="n">sigma_diag</span><span class="p">[:</span> <span class="n">model</span><span class="o">.</span><span class="n">b_size</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51"></a>                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ln_var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span> <span class="o">*</span> <span class="n">sigma_diag</span><span class="p">[:</span> <span class="n">model</span><span class="o">.</span><span class="n">b_size</span><span class="p">]</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52"></a>            <span class="p">)</span>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53"></a>            <span class="n">sigma_diag</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">b_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54"></a>                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ln_var</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span> <span class="o">*</span> <span class="n">sigma_diag</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">b_size</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55"></a>            <span class="p">)</span>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56"></a>    <span class="n">sigma</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">*</span> <span class="n">sigma_diag</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57"></a>    <span class="k">with</span> <span class="n">paddle</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58"></a>        <span class="k">if</span> <span class="n">z_mu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59"></a>            <span class="n">mu</span> <span class="o">=</span> <span class="n">z_mu</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60"></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">z_dim</span><span class="p">)</span>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61"></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">z_dim</span><span class="p">))</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62"></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">paddle</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">paddle</span><span class="o">.</span><span class="n">get_default_dtype</span><span class="p">())</span>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63"></a>        <span class="n">adj</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">true_adj</span><span class="o">=</span><span class="n">true_adj</span><span class="p">)</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64"></a>    <span class="k">return</span> <span class="n">adj</span><span class="p">,</span> <span class="n">x</span>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65"></a>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66"></a>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67"></a><span class="k">class</span> <span class="nc">eval_func</span><span class="p">:</span>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70"></a>        <span class="n">metrics_mode</span><span class="p">,</span>
</span><span id="__span-16-71"><a id="__codelineno-16-71" name="__codelineno-16-71"></a>        <span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-16-72"><a id="__codelineno-16-72" name="__codelineno-16-72"></a>        <span class="n">atomic_num_list</span><span class="p">,</span>
</span><span id="__span-16-73"><a id="__codelineno-16-73" name="__codelineno-16-73"></a>        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="__span-16-74"><a id="__codelineno-16-74" name="__codelineno-16-74"></a>    <span class="p">):</span>
</span><span id="__span-16-75"><a id="__codelineno-16-75" name="__codelineno-16-75"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="__span-16-76"><a id="__codelineno-16-76" name="__codelineno-16-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_mode</span> <span class="o">=</span> <span class="n">metrics_mode</span>
</span><span id="__span-16-77"><a id="__codelineno-16-77" name="__codelineno-16-77"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
</span><span id="__span-16-78"><a id="__codelineno-16-78" name="__codelineno-16-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">atomic_num_list</span> <span class="o">=</span> <span class="n">atomic_num_list</span>
</span><span id="__span-16-79"><a id="__codelineno-16-79" name="__codelineno-16-79"></a>
</span><span id="__span-16-80"><a id="__codelineno-16-80" name="__codelineno-16-80"></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span>
</span><span id="__span-16-81"><a id="__codelineno-16-81" name="__codelineno-16-81"></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="__span-16-82"><a id="__codelineno-16-82" name="__codelineno-16-82"></a>        <span class="n">output_dict</span><span class="p">,</span>
</span><span id="__span-16-83"><a id="__codelineno-16-83" name="__codelineno-16-83"></a>        <span class="n">label_dict</span><span class="p">,</span>
</span><span id="__span-16-84"><a id="__codelineno-16-84" name="__codelineno-16-84"></a>    <span class="p">):</span>
</span><span id="__span-16-85"><a id="__codelineno-16-85" name="__codelineno-16-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_mode</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-16-86"><a id="__codelineno-16-86" name="__codelineno-16-86"></a>        <span class="n">adj</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">infer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metrics_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="__span-16-87"><a id="__codelineno-16-87" name="__codelineno-16-87"></a>        <span class="n">validity_info</span> <span class="o">=</span> <span class="n">check_validity</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-16-88"><a id="__codelineno-16-88" name="__codelineno-16-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics_mode</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-16-89"><a id="__codelineno-16-89" name="__codelineno-16-89"></a>        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="__span-16-90"><a id="__codelineno-16-90" name="__codelineno-16-90"></a>        <span class="n">results</span><span class="p">[</span><span class="s2">"valid"</span><span class="p">]</span> <span class="o">=</span> <span class="n">validity_info</span><span class="p">[</span><span class="s2">"valid_ratio"</span><span class="p">]</span>
</span><span id="__span-16-91"><a id="__codelineno-16-91" name="__codelineno-16-91"></a>        <span class="n">results</span><span class="p">[</span><span class="s2">"unique"</span><span class="p">]</span> <span class="o">=</span> <span class="n">validity_info</span><span class="p">[</span><span class="s2">"unique_ratio"</span><span class="p">]</span>
</span><span id="__span-16-92"><a id="__codelineno-16-92" name="__codelineno-16-92"></a>        <span class="n">results</span><span class="p">[</span><span class="s2">"abs_unique"</span><span class="p">]</span> <span class="o">=</span> <span class="n">validity_info</span><span class="p">[</span><span class="s2">"abs_unique_ratio"</span><span class="p">]</span>
</span><span id="__span-16-93"><a id="__codelineno-16-93" name="__codelineno-16-93"></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="__span-16-94"><a id="__codelineno-16-94" name="__codelineno-16-94"></a>
</span><span id="__span-16-95"><a id="__codelineno-16-95" name="__codelineno-16-95"></a>
</span><span id="__span-16-96"><a id="__codelineno-16-96" name="__codelineno-16-96"></a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
</span><span id="__span-16-97"><a id="__codelineno-16-97" name="__codelineno-16-97"></a>    <span class="c1"># set training hyper-parameters</span>
</span><span id="__span-16-98"><a id="__codelineno-16-98" name="__codelineno-16-98"></a>    <span class="n">b_hidden_ch</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_hidden_ch</span>
</span><span id="__span-16-99"><a id="__codelineno-16-99" name="__codelineno-16-99"></a>    <span class="n">a_hidden_gnn</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_hidden_gnn</span>
</span><span id="__span-16-100"><a id="__codelineno-16-100" name="__codelineno-16-100"></a>    <span class="n">a_hidden_lin</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_hidden_lin</span>
</span><span id="__span-16-101"><a id="__codelineno-16-101" name="__codelineno-16-101"></a>    <span class="n">mask_row_size_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">mask_row_size_list</span><span class="p">)</span>
</span><span id="__span-16-102"><a id="__codelineno-16-102" name="__codelineno-16-102"></a>    <span class="n">mask_row_stride_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">mask_row_stride_list</span><span class="p">)</span>
</span><span id="__span-16-103"><a id="__codelineno-16-103" name="__codelineno-16-103"></a>    <span class="n">a_n_type</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-16-104"><a id="__codelineno-16-104" name="__codelineno-16-104"></a>    <span class="n">atomic_num_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-16-105"><a id="__codelineno-16-105" name="__codelineno-16-105"></a>
</span><span id="__span-16-106"><a id="__codelineno-16-106" name="__codelineno-16-106"></a>    <span class="n">model_params</span> <span class="o">=</span> <span class="n">Hyperparameters</span><span class="p">(</span>
</span><span id="__span-16-107"><a id="__codelineno-16-107" name="__codelineno-16-107"></a>        <span class="n">b_n_type</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_n_type</span><span class="p">,</span>
</span><span id="__span-16-108"><a id="__codelineno-16-108" name="__codelineno-16-108"></a>        <span class="n">b_n_flow</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_n_flow</span><span class="p">,</span>
</span><span id="__span-16-109"><a id="__codelineno-16-109" name="__codelineno-16-109"></a>        <span class="n">b_n_block</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_n_block</span><span class="p">,</span>
</span><span id="__span-16-110"><a id="__codelineno-16-110" name="__codelineno-16-110"></a>        <span class="n">b_n_squeeze</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_n_squeeze</span><span class="p">,</span>
</span><span id="__span-16-111"><a id="__codelineno-16-111" name="__codelineno-16-111"></a>        <span class="n">b_hidden_ch</span><span class="o">=</span><span class="n">b_hidden_ch</span><span class="p">,</span>
</span><span id="__span-16-112"><a id="__codelineno-16-112" name="__codelineno-16-112"></a>        <span class="n">b_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-16-113"><a id="__codelineno-16-113" name="__codelineno-16-113"></a>        <span class="n">b_conv_lu</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">b_conv_lu</span><span class="p">,</span>
</span><span id="__span-16-114"><a id="__codelineno-16-114" name="__codelineno-16-114"></a>        <span class="n">a_n_node</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_n_node</span><span class="p">,</span>
</span><span id="__span-16-115"><a id="__codelineno-16-115" name="__codelineno-16-115"></a>        <span class="n">a_n_type</span><span class="o">=</span><span class="n">a_n_type</span><span class="p">,</span>
</span><span id="__span-16-116"><a id="__codelineno-16-116" name="__codelineno-16-116"></a>        <span class="n">a_hidden_gnn</span><span class="o">=</span><span class="n">a_hidden_gnn</span><span class="p">,</span>
</span><span id="__span-16-117"><a id="__codelineno-16-117" name="__codelineno-16-117"></a>        <span class="n">a_hidden_lin</span><span class="o">=</span><span class="n">a_hidden_lin</span><span class="p">,</span>
</span><span id="__span-16-118"><a id="__codelineno-16-118" name="__codelineno-16-118"></a>        <span class="n">a_n_flow</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_n_flow</span><span class="p">,</span>
</span><span id="__span-16-119"><a id="__codelineno-16-119" name="__codelineno-16-119"></a>        <span class="n">a_n_block</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">a_n_block</span><span class="p">,</span>
</span><span id="__span-16-120"><a id="__codelineno-16-120" name="__codelineno-16-120"></a>        <span class="n">mask_row_size_list</span><span class="o">=</span><span class="n">mask_row_size_list</span><span class="p">,</span>
</span><span id="__span-16-121"><a id="__codelineno-16-121" name="__codelineno-16-121"></a>        <span class="n">mask_row_stride_list</span><span class="o">=</span><span class="n">mask_row_stride_list</span><span class="p">,</span>
</span><span id="__span-16-122"><a id="__codelineno-16-122" name="__codelineno-16-122"></a>        <span class="n">a_affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-16-123"><a id="__codelineno-16-123" name="__codelineno-16-123"></a>        <span class="n">learn_dist</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">learn_dist</span><span class="p">,</span>
</span><span id="__span-16-124"><a id="__codelineno-16-124" name="__codelineno-16-124"></a>        <span class="n">seed</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="__span-16-125"><a id="__codelineno-16-125" name="__codelineno-16-125"></a>        <span class="n">noise_scale</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">noise_scale</span><span class="p">,</span>
</span><span id="__span-16-126"><a id="__codelineno-16-126" name="__codelineno-16-126"></a>    <span class="p">)</span>
</span><span id="__span-16-127"><a id="__codelineno-16-127" name="__codelineno-16-127"></a>
</span><span id="__span-16-128"><a id="__codelineno-16-128" name="__codelineno-16-128"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Model params:</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">model_params</span><span class="o">.</span><span class="n">print</span><span class="p">()))</span>
</span><span id="__span-16-129"><a id="__codelineno-16-129" name="__codelineno-16-129"></a>
</span><span id="__span-16-130"><a id="__codelineno-16-130" name="__codelineno-16-130"></a>    <span class="c1"># set transforms</span>
</span><span id="__span-16-131"><a id="__codelineno-16-131" name="__codelineno-16-131"></a>    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span> <span class="o">==</span> <span class="s2">"qm9"</span><span class="p">:</span>
</span><span id="__span-16-132"><a id="__codelineno-16-132" name="__codelineno-16-132"></a>        <span class="n">transform_fn</span> <span class="o">=</span> <span class="n">moflow_transform</span><span class="o">.</span><span class="n">transform_fn</span>
</span><span id="__span-16-133"><a id="__codelineno-16-133" name="__codelineno-16-133"></a>    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span> <span class="o">==</span> <span class="s2">"zinc250k"</span><span class="p">:</span>
</span><span id="__span-16-134"><a id="__codelineno-16-134" name="__codelineno-16-134"></a>        <span class="n">transform_fn</span> <span class="o">=</span> <span class="n">moflow_transform</span><span class="o">.</span><span class="n">transform_fn_zinc250k</span>
</span><span id="__span-16-135"><a id="__codelineno-16-135" name="__codelineno-16-135"></a>
</span><span id="__span-16-136"><a id="__codelineno-16-136" name="__codelineno-16-136"></a>    <span class="c1"># set select eval data</span>
</span><span id="__span-16-137"><a id="__codelineno-16-137" name="__codelineno-16-137"></a>    <span class="n">valid_idx_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">valid_idx</span><span class="p">)</span>
</span><span id="__span-16-138"><a id="__codelineno-16-138" name="__codelineno-16-138"></a>    <span class="n">valid_idx</span> <span class="o">=</span> <span class="n">moflow_transform</span><span class="o">.</span><span class="n">get_val_ids</span><span class="p">(</span><span class="n">valid_idx_path</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span>
</span><span id="__span-16-139"><a id="__codelineno-16-139" name="__codelineno-16-139"></a>
</span><span id="__span-16-140"><a id="__codelineno-16-140" name="__codelineno-16-140"></a>    <span class="c1"># set train dataloader config</span>
</span><span id="__span-16-141"><a id="__codelineno-16-141" name="__codelineno-16-141"></a>    <span class="n">train_dataloader_cfg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-142"><a id="__codelineno-16-142" name="__codelineno-16-142"></a>        <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-143"><a id="__codelineno-16-143" name="__codelineno-16-143"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"MOlFLOWDataset"</span><span class="p">,</span>
</span><span id="__span-16-144"><a id="__codelineno-16-144" name="__codelineno-16-144"></a>            <span class="s2">"file_path"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span>
</span><span id="__span-16-145"><a id="__codelineno-16-145" name="__codelineno-16-145"></a>            <span class="s2">"data_name"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-16-146"><a id="__codelineno-16-146" name="__codelineno-16-146"></a>            <span class="s2">"mode"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
</span><span id="__span-16-147"><a id="__codelineno-16-147" name="__codelineno-16-147"></a>            <span class="s2">"valid_idx"</span><span class="p">:</span> <span class="n">valid_idx</span><span class="p">,</span>
</span><span id="__span-16-148"><a id="__codelineno-16-148" name="__codelineno-16-148"></a>            <span class="s2">"input_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">input_keys</span><span class="p">,</span>
</span><span id="__span-16-149"><a id="__codelineno-16-149" name="__codelineno-16-149"></a>            <span class="s2">"label_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">label_keys</span><span class="p">,</span>
</span><span id="__span-16-150"><a id="__codelineno-16-150" name="__codelineno-16-150"></a>            <span class="s2">"smiles_col"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
</span><span id="__span-16-151"><a id="__codelineno-16-151" name="__codelineno-16-151"></a>            <span class="s2">"transform_fn"</span><span class="p">:</span> <span class="n">transform_fn</span><span class="p">,</span>
</span><span id="__span-16-152"><a id="__codelineno-16-152" name="__codelineno-16-152"></a>        <span class="p">},</span>
</span><span id="__span-16-153"><a id="__codelineno-16-153" name="__codelineno-16-153"></a>        <span class="s2">"sampler"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-154"><a id="__codelineno-16-154" name="__codelineno-16-154"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"BatchSampler"</span><span class="p">,</span>
</span><span id="__span-16-155"><a id="__codelineno-16-155" name="__codelineno-16-155"></a>            <span class="s2">"drop_last"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="__span-16-156"><a id="__codelineno-16-156" name="__codelineno-16-156"></a>            <span class="s2">"shuffle"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="__span-16-157"><a id="__codelineno-16-157" name="__codelineno-16-157"></a>        <span class="p">},</span>
</span><span id="__span-16-158"><a id="__codelineno-16-158" name="__codelineno-16-158"></a>        <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-16-159"><a id="__codelineno-16-159" name="__codelineno-16-159"></a>        <span class="s2">"num_workers"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
</span><span id="__span-16-160"><a id="__codelineno-16-160" name="__codelineno-16-160"></a>    <span class="p">}</span>
</span><span id="__span-16-161"><a id="__codelineno-16-161" name="__codelineno-16-161"></a>
</span><span id="__span-16-162"><a id="__codelineno-16-162" name="__codelineno-16-162"></a>    <span class="c1"># set model</span>
</span><span id="__span-16-163"><a id="__codelineno-16-163" name="__codelineno-16-163"></a>    <span class="n">model_cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="p">)</span>
</span><span id="__span-16-164"><a id="__codelineno-16-164" name="__codelineno-16-164"></a>    <span class="n">model_cfg</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">"hyper_params"</span><span class="p">:</span> <span class="n">model_params</span><span class="p">})</span>
</span><span id="__span-16-165"><a id="__codelineno-16-165" name="__codelineno-16-165"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">arch</span><span class="o">.</span><span class="n">MoFlowNet</span><span class="p">(</span><span class="o">**</span><span class="n">model_cfg</span><span class="p">)</span>
</span><span id="__span-16-166"><a id="__codelineno-16-166" name="__codelineno-16-166"></a>
</span><span id="__span-16-167"><a id="__codelineno-16-167" name="__codelineno-16-167"></a>    <span class="c1"># set constraint</span>
</span><span id="__span-16-168"><a id="__codelineno-16-168" name="__codelineno-16-168"></a>    <span class="n">output_keys</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">output_keys</span>
</span><span id="__span-16-169"><a id="__codelineno-16-169" name="__codelineno-16-169"></a>    <span class="n">sup_constraint</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">SupervisedConstraint</span><span class="p">(</span>
</span><span id="__span-16-170"><a id="__codelineno-16-170" name="__codelineno-16-170"></a>        <span class="n">train_dataloader_cfg</span><span class="p">,</span>
</span><span id="__span-16-171"><a id="__codelineno-16-171" name="__codelineno-16-171"></a>        <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">log_prob_loss</span><span class="p">),</span>
</span><span id="__span-16-172"><a id="__codelineno-16-172" name="__codelineno-16-172"></a>        <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">out</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">key</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output_keys</span><span class="p">},</span>
</span><span id="__span-16-173"><a id="__codelineno-16-173" name="__codelineno-16-173"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"Sup_constraint"</span><span class="p">,</span>
</span><span id="__span-16-174"><a id="__codelineno-16-174" name="__codelineno-16-174"></a>    <span class="p">)</span>
</span><span id="__span-16-175"><a id="__codelineno-16-175" name="__codelineno-16-175"></a>
</span><span id="__span-16-176"><a id="__codelineno-16-176" name="__codelineno-16-176"></a>    <span class="n">constraint</span> <span class="o">=</span> <span class="p">{</span><span class="n">sup_constraint</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_constraint</span><span class="p">}</span>
</span><span id="__span-16-177"><a id="__codelineno-16-177" name="__codelineno-16-177"></a>
</span><span id="__span-16-178"><a id="__codelineno-16-178" name="__codelineno-16-178"></a>    <span class="c1"># set iters_per_epoch by dataloader length</span>
</span><span id="__span-16-179"><a id="__codelineno-16-179" name="__codelineno-16-179"></a>    <span class="n">ITERS_PER_EPOCH</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sup_constraint</span><span class="o">.</span><span class="n">data_loader</span><span class="p">)</span>
</span><span id="__span-16-180"><a id="__codelineno-16-180" name="__codelineno-16-180"></a>
</span><span id="__span-16-181"><a id="__codelineno-16-181" name="__codelineno-16-181"></a>    <span class="c1"># init optimizer and lr scheduler</span>
</span><span id="__span-16-182"><a id="__codelineno-16-182" name="__codelineno-16-182"></a>    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)(</span><span class="n">model</span><span class="p">)</span>
</span><span id="__span-16-183"><a id="__codelineno-16-183" name="__codelineno-16-183"></a>
</span><span id="__span-16-184"><a id="__codelineno-16-184" name="__codelineno-16-184"></a>    <span class="c1"># set eval dataloader config</span>
</span><span id="__span-16-185"><a id="__codelineno-16-185" name="__codelineno-16-185"></a>    <span class="n">eval_dataloader_cfg</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-186"><a id="__codelineno-16-186" name="__codelineno-16-186"></a>        <span class="s2">"dataset"</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-16-187"><a id="__codelineno-16-187" name="__codelineno-16-187"></a>            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"MOlFLOWDataset"</span><span class="p">,</span>
</span><span id="__span-16-188"><a id="__codelineno-16-188" name="__codelineno-16-188"></a>            <span class="s2">"file_path"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span>
</span><span id="__span-16-189"><a id="__codelineno-16-189" name="__codelineno-16-189"></a>            <span class="s2">"data_name"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">,</span>
</span><span id="__span-16-190"><a id="__codelineno-16-190" name="__codelineno-16-190"></a>            <span class="s2">"mode"</span><span class="p">:</span> <span class="s2">"eval"</span><span class="p">,</span>
</span><span id="__span-16-191"><a id="__codelineno-16-191" name="__codelineno-16-191"></a>            <span class="s2">"valid_idx"</span><span class="p">:</span> <span class="n">valid_idx</span><span class="p">,</span>
</span><span id="__span-16-192"><a id="__codelineno-16-192" name="__codelineno-16-192"></a>            <span class="s2">"input_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">input_keys</span><span class="p">,</span>
</span><span id="__span-16-193"><a id="__codelineno-16-193" name="__codelineno-16-193"></a>            <span class="s2">"label_keys"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">label_keys</span><span class="p">,</span>
</span><span id="__span-16-194"><a id="__codelineno-16-194" name="__codelineno-16-194"></a>            <span class="s2">"smiles_col"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_name</span><span class="p">)</span><span class="o">.</span><span class="n">smiles_col</span><span class="p">,</span>
</span><span id="__span-16-195"><a id="__codelineno-16-195" name="__codelineno-16-195"></a>            <span class="s2">"transform_fn"</span><span class="p">:</span> <span class="n">transform_fn</span><span class="p">,</span>
</span><span id="__span-16-196"><a id="__codelineno-16-196" name="__codelineno-16-196"></a>        <span class="p">},</span>
</span><span id="__span-16-197"><a id="__codelineno-16-197" name="__codelineno-16-197"></a>        <span class="s2">"batch_size"</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="__span-16-198"><a id="__codelineno-16-198" name="__codelineno-16-198"></a>    <span class="p">}</span>
</span><span id="__span-16-199"><a id="__codelineno-16-199" name="__codelineno-16-199"></a>
</span><span id="__span-16-200"><a id="__codelineno-16-200" name="__codelineno-16-200"></a>    <span class="c1"># set validator</span>
</span><span id="__span-16-201"><a id="__codelineno-16-201" name="__codelineno-16-201"></a>    <span class="n">sup_validator</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">validate</span><span class="o">.</span><span class="n">SupervisedValidator</span><span class="p">(</span>
</span><span id="__span-16-202"><a id="__codelineno-16-202" name="__codelineno-16-202"></a>        <span class="n">eval_dataloader_cfg</span><span class="p">,</span>
</span><span id="__span-16-203"><a id="__codelineno-16-203" name="__codelineno-16-203"></a>        <span class="n">ppsci</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">FunctionalLoss</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">log_prob_loss</span><span class="p">),</span>
</span><span id="__span-16-204"><a id="__codelineno-16-204" name="__codelineno-16-204"></a>        <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">out</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">key</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output_keys</span><span class="p">},</span>
</span><span id="__span-16-205"><a id="__codelineno-16-205" name="__codelineno-16-205"></a>        <span class="n">metric</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-16-206"><a id="__codelineno-16-206" name="__codelineno-16-206"></a>            <span class="s2">"Valid"</span><span class="p">:</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">FunctionalMetric</span><span class="p">(</span>
</span><span id="__span-16-207"><a id="__codelineno-16-207" name="__codelineno-16-207"></a>                <span class="n">eval_func</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">atomic_num_list</span><span class="p">)</span>
</span><span id="__span-16-208"><a id="__codelineno-16-208" name="__codelineno-16-208"></a>            <span class="p">)</span>
</span><span id="__span-16-209"><a id="__codelineno-16-209" name="__codelineno-16-209"></a>        <span class="p">},</span>
</span><span id="__span-16-210"><a id="__codelineno-16-210" name="__codelineno-16-210"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">"Sup_Validator"</span><span class="p">,</span>
</span><span id="__span-16-211"><a id="__codelineno-16-211" name="__codelineno-16-211"></a>    <span class="p">)</span>
</span><span id="__span-16-212"><a id="__codelineno-16-212" name="__codelineno-16-212"></a>    <span class="n">validator</span> <span class="o">=</span> <span class="p">{</span><span class="n">sup_validator</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">sup_validator</span><span class="p">}</span>
</span><span id="__span-16-213"><a id="__codelineno-16-213" name="__codelineno-16-213"></a>
</span><span id="__span-16-214"><a id="__codelineno-16-214" name="__codelineno-16-214"></a>    <span class="c1"># initialize solver</span>
</span><span id="__span-16-215"><a id="__codelineno-16-215" name="__codelineno-16-215"></a>    <span class="n">solver</span> <span class="o">=</span> <span class="n">ppsci</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Solver</span><span class="p">(</span>
</span><span id="__span-16-216"><a id="__codelineno-16-216" name="__codelineno-16-216"></a>        <span class="n">model</span><span class="p">,</span>
</span><span id="__span-16-217"><a id="__codelineno-16-217" name="__codelineno-16-217"></a>        <span class="n">constraint</span><span class="p">,</span>
</span><span id="__span-16-218"><a id="__codelineno-16-218" name="__codelineno-16-218"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
</span><span id="__span-16-219"><a id="__codelineno-16-219" name="__codelineno-16-219"></a>        <span class="n">optimizer</span><span class="p">,</span>
</span><span id="__span-16-220"><a id="__codelineno-16-220" name="__codelineno-16-220"></a>        <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-16-221"><a id="__codelineno-16-221" name="__codelineno-16-221"></a>        <span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">epochs</span><span class="p">,</span>
</span><span id="__span-16-222"><a id="__codelineno-16-222" name="__codelineno-16-222"></a>        <span class="n">ITERS_PER_EPOCH</span><span class="p">,</span>
</span><span id="__span-16-223"><a id="__codelineno-16-223" name="__codelineno-16-223"></a>        <span class="n">seed</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
</span><span id="__span-16-224"><a id="__codelineno-16-224" name="__codelineno-16-224"></a>        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
</span><span id="__span-16-225"><a id="__codelineno-16-225" name="__codelineno-16-225"></a>        <span class="n">save_freq</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">save_freq</span><span class="p">,</span>
</span><span id="__span-16-226"><a id="__codelineno-16-226" name="__codelineno-16-226"></a>        <span class="n">eval_during_train</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">eval_during_train</span><span class="p">,</span>
</span><span id="__span-16-227"><a id="__codelineno-16-227" name="__codelineno-16-227"></a>        <span class="n">eval_freq</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">TRAIN</span><span class="o">.</span><span class="n">eval_freq</span><span class="p">,</span>
</span><span id="__span-16-228"><a id="__codelineno-16-228" name="__codelineno-16-228"></a>        <span class="n">compute_metric_by_batch</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">compute_metric_by_batch</span><span class="p">,</span>
</span><span id="__span-16-229"><a id="__codelineno-16-229" name="__codelineno-16-229"></a>        <span class="n">eval_with_no_grad</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">EVAL</span><span class="o">.</span><span class="n">eval_with_no_grad</span><span class="p">,</span>
</span><span id="__span-16-230"><a id="__codelineno-16-230" name="__codelineno-16-230"></a>    <span class="p">)</span>
</span><span id="__span-16-231"><a id="__codelineno-16-231" name="__codelineno-16-231"></a>    <span class="c1"># train model</span>
</span><span id="__span-16-232"><a id="__codelineno-16-232" name="__codelineno-16-232"></a>    <span class="n">solver</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</span><span id="__span-16-233"><a id="__codelineno-16-233" name="__codelineno-16-233"></a>
</span><span id="__span-16-234"><a id="__codelineno-16-234" name="__codelineno-16-234"></a>    <span class="c1"># validation for training</span>
</span><span id="__span-16-235"><a id="__codelineno-16-235" name="__codelineno-16-235"></a>    <span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="__span-16-236"><a id="__codelineno-16-236" name="__codelineno-16-236"></a>
</span><span id="__span-16-237"><a id="__codelineno-16-237" name="__codelineno-16-237"></a>
</span><span id="__span-16-238"><a id="__codelineno-16-238" name="__codelineno-16-238"></a><span class="nd">@hydra</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">version_base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="s2">"./conf"</span><span class="p">,</span> <span class="n">config_name</span><span class="o">=</span><span class="s2">"moflow_train.yaml"</span><span class="p">)</span>
</span><span id="__span-16-239"><a id="__codelineno-16-239" name="__codelineno-16-239"></a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">DictConfig</span><span class="p">):</span>
</span><span id="__span-16-240"><a id="__codelineno-16-240" name="__codelineno-16-240"></a>    <span class="n">train</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</span><span id="__span-16-241"><a id="__codelineno-16-241" name="__codelineno-16-241"></a>
</span><span id="__span-16-242"><a id="__codelineno-16-242" name="__codelineno-16-242"></a>
</span><span id="__span-16-243"><a id="__codelineno-16-243" name="__codelineno-16-243"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span><span id="__span-16-244"><a id="__codelineno-16-244" name="__codelineno-16-244"></a>    <span class="n">main</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="5">5.参考文献<a class="headerlink" href="#5" title="Permanent link">¶</a></h2>
<p>【文章】<a href="https://arxiv.org/abs/2006.10137v1">MoFlow: An Invertible Flow Model for Generating Molecular Graphs</a></p>
<p>【Code】<a href="https://github.com/calvin-zcx/moflow">Moflow</a></p></div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年8月22日</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年8月20日</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 - 2023 PaddlePaddle
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.sections", "navigation.top", "search.suggest", "navigation.instant", "content.code.copy", "content.code.select", "content.code.annotate", "search.highlight", "content.tabs.link", "content.action.edit", "content.action.view", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": {"alias": true, "provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../../javascripts/bd_statistics.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="../../../javascripts/contributors.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>